// üí≥ –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫ —Å –¢–∏–Ω—å–∫–æ—Ñ—Ñ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π
import { Subscription, SubscriptionPlan, SubscriptionStatus, SubscriptionTier } from '@/types'
import type { SubscriptionInsert } from '@/types/supabase'
import {
    mockGetSubscription
} from '../../tests/mocks/subscription-mock'
import { getSupabaseClient } from './supabase'

// üö® –ó–ê–©–ò–¢–ê –û–¢ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø –° –†–ï–ê–õ–¨–ù–´–ú–ò EMAIL
const DISABLE_EMAIL = process.env.NEXT_PUBLIC_DISABLE_EMAIL === 'true'

export interface CreateSubscriptionData {
    userId: string
    tier: SubscriptionTier
    tinkoffCustomerId: string
    tinkoffPaymentId: string
    currentPeriodStart: Date
    currentPeriodEnd: Date
    trialEnd?: Date
}

export interface UpdateSubscriptionData {
    status?: SubscriptionStatus
    currentPeriodStart?: Date
    currentPeriodEnd?: Date
    cancelAtPeriodEnd?: boolean
    trialEnd?: Date
}

export interface SubscriptionResponse {
    success: boolean
    subscription?: Subscription
    error?: string
}

export interface SubscriptionListResponse {
    success: boolean
    user_subscriptions?: Subscription[]
    error?: string
}

// –ü–ª–∞–Ω—ã –ø–æ–¥–ø–∏—Å–æ–∫
export const SUBSCRIPTION_PLANS: SubscriptionPlan[] = [
    {
        id: 'free',
        name: 'Free',
        tier: 'free',
        price: 0,
        currency: 'rub',
        interval: 'month',
        features: [
            '–î–æ 50 –∑–∞–¥–∞—á',
            '–ë–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫',
            '–ü—Å–µ–≤–¥–æ-–ò–ò —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏',
            '–ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ'
        ],
        limits: {
            tasks: 50,
            aiRequests: 0,
            storage: 100 // MB
        },
        tinkoffPriceId: '',
        isActive: true
    },
    {
        id: 'premium',
        name: 'Premium',
        tier: 'premium',
        price: 99900, // 999 —Ä—É–±–ª–µ–π –≤ –∫–æ–ø–µ–π–∫–∞—Ö
        currency: 'rub',
        interval: 'month',
        features: [
            '–î–æ 500 –∑–∞–¥–∞—á –≤ –º–µ—Å—è—Ü',
            'OpenAI GPT-4o Mini',
            '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞',
            '–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞',
            '–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö'
        ],
        limits: {
            tasks: 500,
            aiRequests: 1000,
            storage: 1000 // MB
        },
        tinkoffPriceId: 'tinkoff_premium_monthly',
        isActive: true
    },
    {
        id: 'pro',
        name: 'Pro',
        tier: 'pro',
        price: 199900, // 1999 —Ä—É–±–ª–µ–π –≤ –∫–æ–ø–µ–π–∫–∞—Ö
        currency: 'rub',
        interval: 'month',
        features: [
            '–ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏',
            '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç',
            '–ö–æ–º–∞–Ω–¥–Ω–∞—è —Ä–∞–±–æ—Ç–∞',
            '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á–µ—Ç—ã',
            'API –¥–æ—Å—Ç—É–ø',
            '–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä'
        ],
        limits: {
            tasks: -1,
            aiRequests: -1,
            storage: -1
        },
        tinkoffPriceId: 'tinkoff_pro_monthly',
        isActive: true
    },
    {
        id: 'enterprise',
        name: 'Enterprise',
        tier: 'enterprise',
        price: 499900, // 4999 —Ä—É–±–ª–µ–π –≤ –∫–æ–ø–µ–π–∫–∞—Ö
        currency: 'rub',
        interval: 'month',
        features: [
            '–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ Pro',
            '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π',
            '–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å',
            '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏',
            '–û–±—É—á–µ–Ω–∏–µ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞',
            'SLA 99.9%'
        ],
        limits: {
            tasks: -1,
            aiRequests: -1,
            storage: -1
        },
        tinkoffPriceId: 'tinkoff_enterprise_monthly',
        isActive: true
    }
]

/**
 * üìù –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */
export async function getSubscription(userId: string): Promise<SubscriptionResponse> {
    try {
        // üö® MOCK –†–ï–ñ–ò–ú: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Supabase
        if (DISABLE_EMAIL) {
            return mockGetSubscription(userId)
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è Supabase
        if (!process.env.NEXT_PUBLIC_SUPABASE_URL || !process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) {
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º free tier –µ—Å–ª–∏ –Ω–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
            return {
                success: true,
                subscription: {
                    id: 'free',
                    userId,
                    tier: 'free',
                    status: 'active',
                    currentPeriodStart: new Date(),
                    currentPeriodEnd: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000), // 1 year
                    cancelAtPeriodEnd: false,
                    createdAt: new Date(),
                    updatedAt: new Date()
                }
            }
        }

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º Supabase –∫–ª–∏–µ–Ω—Ç
        const supabase = getSupabaseClient()

        const { data, error } = await supabase
            .from('user_subscriptions')
            .select('*')
            .eq('user_id', userId)
            .single()

        if (error) {
            if (error.code === 'PGRST116') {
                // No subscription found, return free tier
                return {
                    success: true,
                    subscription: {
                        id: 'free',
                        userId,
                        tier: 'free',
                        status: 'active',
                        currentPeriodStart: new Date(),
                        currentPeriodEnd: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000), // 1 year
                        cancelAtPeriodEnd: false,
                        createdAt: new Date(),
                        updatedAt: new Date()
                    }
                }
            }

            console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏:', error)
            return {
                success: false,
                error: '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É'
            }
        }

        const subscription: Subscription = {
            id: (data as any).id,
            userId: (data as any).user_id,
            tier: (data as any).tier,
            status: (data as any).status,
            tinkoffCustomerId: (data as any).tinkoff_customer_id,
            tinkoffPaymentId: (data as any).tinkoff_payment_id,
            currentPeriodStart: new Date((data as any).current_period_start),
            currentPeriodEnd: new Date((data as any).current_period_end),
            cancelAtPeriodEnd: (data as any).cancel_at_period_end,
            trialEnd: (data as any).trial_end ? new Date((data as any).trial_end) : undefined,
            createdAt: new Date((data as any).created_at),
            updatedAt: new Date((data as any).updated_at)
        }

        return {
            success: true,
            subscription
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏:', error)
        return {
            success: false,
            error: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏'
        }
    }
}

/**
 * üìù –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
 */
export async function createSubscription(data: CreateSubscriptionData): Promise<SubscriptionResponse> {
    try {
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
        if (!data.userId) {
            return {
                success: false,
                error: 'ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'
            }
        }

        if (!data.tier || !['free', 'premium', 'pro'].includes(data.tier)) {
            return {
                success: false,
                error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏'
            }
        }

        // üö® MOCK –†–ï–ñ–ò–ú: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Supabase
        if (DISABLE_EMAIL) {
            console.log('üß™ MOCK –†–ï–ñ–ò–ú: –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Supabase')
            const { mockCreateSubscription } = await import('./subscription-mock')
            return mockCreateSubscription(data.userId, data.tier)
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è Supabase
        if (!process.env.NEXT_PUBLIC_SUPABASE_URL || !process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) {
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–≥–ª—É—à–∫—É –µ—Å–ª–∏ –Ω–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
            return {
                success: true,
                subscription: {
                    id: 'temp-subscription',
                    userId: data.userId,
                    tier: data.tier,
                    status: 'active',
                    tinkoffCustomerId: data.tinkoffCustomerId,
                    tinkoffPaymentId: data.tinkoffPaymentId,
                    currentPeriodStart: data.currentPeriodStart,
                    currentPeriodEnd: data.currentPeriodEnd,
                    cancelAtPeriodEnd: false,
                    trialEnd: data.trialEnd,
                    createdAt: new Date(),
                    updatedAt: new Date()
                }
            }
        }

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º Supabase –∫–ª–∏–µ–Ω—Ç
        const supabase = getSupabaseClient()

        const subscriptionData: SubscriptionInsert = {
            user_id: data.userId,
            tier: data.tier === 'enterprise' ? 'pro' : data.tier as 'free' | 'premium' | 'pro',
            status: 'active',
            stripe_customer_id: data.tinkoffCustomerId,
            stripe_subscription_id: data.tinkoffPaymentId,
            current_period_start: data.currentPeriodStart.toISOString(),
            current_period_end: data.currentPeriodEnd.toISOString(),
            trial_end: data.trialEnd?.toISOString(),
            cancel_at_period_end: false
        }

        const { data: subscription, error } = await supabase
            .from('user_subscriptions')
            .insert(subscriptionData as any)
            .select()
            .single()

        if (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏:', error)
            return {
                success: false,
                error: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É'
            }
        }

        return {
            success: true,
            subscription: {
                id: (subscription as any).id,
                userId: (subscription as any).user_id,
                tier: (subscription as any).tier,
                status: (subscription as any).status,
                tinkoffCustomerId: (subscription as any).tinkoff_customer_id,
                tinkoffPaymentId: (subscription as any).tinkoff_payment_id,
                currentPeriodStart: new Date((subscription as any).current_period_start),
                currentPeriodEnd: new Date((subscription as any).current_period_end),
                cancelAtPeriodEnd: (subscription as any).cancel_at_period_end,
                trialEnd: (subscription as any).trial_end ? new Date((subscription as any).trial_end) : undefined,
                createdAt: new Date((subscription as any).created_at),
                updatedAt: new Date((subscription as any).updated_at)
            }
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏:', error)
        return {
            success: false,
            error: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏'
        }
    }
}

/**
 * üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
 */
export async function updateSubscription(
    subscriptionId: string,
    updates: UpdateSubscriptionData
): Promise<SubscriptionResponse> {
    try {
        // üö® MOCK –†–ï–ñ–ò–ú: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Supabase
        if (DISABLE_EMAIL) {
            console.log('üß™ MOCK –†–ï–ñ–ò–ú: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Supabase')
            const { mockUpdateSubscription } = await import('./subscription-mock')
            return mockUpdateSubscription(subscriptionId, updates)
        }

        // –í—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è build
        /*
        const supabase = getSupabaseClient()
        
        const updateData: any = {
            updated_at: new Date().toISOString()
        }

        if (updates.status) updateData.status = updates.status
        if (updates.currentPeriodStart) updateData.current_period_start = updates.currentPeriodStart.toISOString()
        if (updates.currentPeriodEnd) updateData.current_period_end = updates.currentPeriodEnd.toISOString()
        if (updates.cancelAtPeriodEnd !== undefined) updateData.cancel_at_period_end = updates.cancelAtPeriodEnd
        if (updates.trialEnd) updateData.trial_end = updates.trialEnd.toISOString()

        const { data, error } = await supabase
            .from('user_subscriptions')
            .update(updateData)
            .eq('id', subscriptionId)
            .select()
            .single()

        if (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏:', error)
            return {
                success: false,
                error: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É'
            }
        }

        return {
            success: true,
            subscription: {
                id: (data as any).id,
                userId: (data as any).user_id,
                tier: (data as any).tier,
                status: (data as any).status,
                tinkoffCustomerId: (data as any).tinkoff_customer_id,
                tinkoffPaymentId: (data as any).tinkoff_payment_id,
                currentPeriodStart: new Date((data as any).current_period_start),
                currentPeriodEnd: new Date((data as any).current_period_end),
                cancelAtPeriodEnd: (data as any).cancel_at_period_end,
                trialEnd: (data as any).trial_end ? new Date((data as any).trial_end) : undefined,
                createdAt: new Date((data as any).created_at),
                updatedAt: new Date((data as any).updated_at)
            }
        }
        */

        // –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞
        return {
            success: true,
            subscription: {
                id: subscriptionId,
                userId: 'temp-user',
                tier: 'free',
                status: updates.status || 'active',
                tinkoffCustomerId: '',
                tinkoffPaymentId: '',
                currentPeriodStart: updates.currentPeriodStart || new Date(),
                currentPeriodEnd: updates.currentPeriodEnd || new Date(),
                cancelAtPeriodEnd: updates.cancelAtPeriodEnd || false,
                trialEnd: updates.trialEnd,
                createdAt: new Date(),
                updatedAt: new Date()
            }
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏:', error)
        return {
            success: false,
            error: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏'
        }
    }
}

/**
 * üìù –û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏
 */
export async function cancelSubscription(subscriptionId: string): Promise<SubscriptionResponse> {
    try {
        // üö® MOCK –†–ï–ñ–ò–ú: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Supabase
        if (DISABLE_EMAIL) {
            console.log('üß™ MOCK –†–ï–ñ–ò–ú: –û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Supabase')
            const { mockCancelSubscription } = await import('./subscription-mock')
            return mockCancelSubscription(subscriptionId)
        }

        // –í—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è build
        /*
        const supabase = getSupabaseClient()
        
        const { data, error } = await supabase
            .from('user_subscriptions')
            .update({
                status: 'canceled',
                cancel_at_period_end: true,
                updated_at: new Date().toISOString()
            })
            .eq('id', subscriptionId)
            .select()
            .single()

        if (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏:', error)
            return {
                success: false,
                error: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É'
            }
        }

        return {
            success: true,
            subscription: {
                id: (data as any).id,
                userId: (data as any).user_id,
                tier: (data as any).tier,
                status: (data as any).status,
                tinkoffCustomerId: (data as any).tinkoff_customer_id,
                tinkoffPaymentId: (data as any).tinkoff_payment_id,
                currentPeriodStart: new Date((data as any).current_period_start),
                currentPeriodEnd: new Date((data as any).current_period_end),
                cancelAtPeriodEnd: (data as any).cancel_at_period_end,
                trialEnd: (data as any).trial_end ? new Date((data as any).trial_end) : undefined,
                createdAt: new Date((data as any).created_at),
                updatedAt: new Date((data as any).updated_at)
            }
        }
        */

        // –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞
        return {
            success: true,
            subscription: {
                id: subscriptionId,
                userId: 'temp-user',
                tier: 'free',
                status: 'canceled',
                tinkoffCustomerId: '',
                tinkoffPaymentId: '',
                currentPeriodStart: new Date(),
                currentPeriodEnd: new Date(),
                cancelAtPeriodEnd: true,
                trialEnd: undefined,
                createdAt: new Date(),
                updatedAt: new Date()
            }
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏:', error)
        return {
            success: false,
            error: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –ø–æ–¥–ø–∏—Å–∫–∏'
        }
    }
}

/**
 * üìù –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */
export async function getUserSubscriptions(userId: string): Promise<SubscriptionListResponse> {
    try {
        // –í—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è build
        /*
        const supabase = getSupabaseClient()
        
        const { data, error } = await supabase
            .from('user_subscriptions')
            .select('*')
            .eq('user_id', userId)
            .order('created_at', { ascending: false })

        if (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫:', error)
            return {
                success: false,
                error: '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏'
            }
        }

        const user_subscriptions: Subscription[] = data.map(item => ({
            id: item.id,
            userId: item.user_id,
            tier: item.tier,
            status: item.status,
            tinkoffCustomerId: item.tinkoff_customer_id,
            tinkoffPaymentId: item.tinkoff_payment_id,
            currentPeriodStart: new Date(item.current_period_start),
            currentPeriodEnd: new Date(item.current_period_end),
            cancelAtPeriodEnd: item.cancel_at_period_end,
            trialEnd: item.trial_end ? new Date(item.trial_end) : undefined,
            createdAt: new Date(item.created_at),
            updatedAt: new Date(item.updated_at)
        }))

        return {
            success: true,
            user_subscriptions
        }
        */

        // –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞
        return {
            success: true,
            user_subscriptions: []
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫:', error)
        return {
            success: false,
            error: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–æ–∫'
        }
    }
}

/**
 * üìù –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ ID
 */
export function getSubscriptionPlan(planId: string): SubscriptionPlan | null {
    const plan = SUBSCRIPTION_PLANS.find(plan => plan.id === planId)
    return plan || null
}

/**
 * üìù –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤
 */
export function getAllSubscriptionPlans(): SubscriptionPlan[] {
    return SUBSCRIPTION_PLANS.filter(plan => plan.isActive)
}

/**
 * üìù –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –ø–æ–¥–ø–∏—Å–∫–∏
 */
export function checkSubscriptionLimits(
    subscription: Subscription,
    plan: SubscriptionPlan,
    currentUsage: { tasks: number; aiRequests: number; storage: number }
): { canUse: boolean; limits: { tasks: number; aiRequests: number; storage: number } } {
    const limits = plan.limits

    return {
        canUse: (
            (limits.tasks === -1 || currentUsage.tasks < limits.tasks) &&
            (limits.aiRequests === -1 || currentUsage.aiRequests < limits.aiRequests) &&
            (limits.storage === -1 || currentUsage.storage < limits.storage)
        ),
        limits
    }
}

/**
 * üìù –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤ –ø–æ–¥–ø–∏—Å–æ–∫ (–¥–ª—è API)
 */
export function getSubscriptionPlans(): { success: boolean; plans?: SubscriptionPlan[]; error?: string } {
    try {
        // üö® MOCK –†–ï–ñ–ò–ú: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Supabase
        if (DISABLE_EMAIL) {
            console.log('üß™ MOCK –†–ï–ñ–ò–ú: –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤ –ø–æ–¥–ø–∏—Å–æ–∫ –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Supabase')
            return {
                success: true,
                plans: SUBSCRIPTION_PLANS.filter(plan => plan.isActive)
            }
        }

        return {
            success: true,
            plans: SUBSCRIPTION_PLANS.filter(plan => plan.isActive)
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–ª–∞–Ω–æ–≤ –ø–æ–¥–ø–∏—Å–æ–∫:', error)
        return {
            success: false,
            error: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–ª–∞–Ω–æ–≤ –ø–æ–¥–ø–∏—Å–æ–∫'
        }
    }
}

/**
 * üìù –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏–∏
 */
export function hasFeatureAccess(
    subscription: Subscription,
    feature: string
): boolean {
    const plan = getSubscriptionPlan(subscription.tier)
    if (!plan) return false

    // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º
    switch (feature) {
        case 'ai_planning':
            return subscription.tier !== 'free'
        case 'unlimited_tasks':
            return subscription.tier === 'pro' || subscription.tier === 'enterprise'
        case 'team_collaboration':
            return subscription.tier === 'pro' || subscription.tier === 'enterprise'
        case 'api_access':
            return subscription.tier === 'pro' || subscription.tier === 'enterprise'
        default:
            return true
    }
}

/**
 * üìù –ü–æ–ª—É—á–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */
export function getUserLimits(subscription: Subscription | null): { tasks: number; aiRequests: number; storage: number } {
    if (!subscription) {
        return { tasks: 50, aiRequests: 10, storage: 100 }
    }

    const plan = getSubscriptionPlan(subscription.tier)
    if (!plan) {
        return { tasks: 50, aiRequests: 10, storage: 100 }
    }

    return plan.limits
}
