name: ðŸ”’ Security Check

on:
  schedule:
    - cron: '0 2 * * 1'  # ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº Ð² 2:00
  push:
    branches: [ main, develop, release/* ]
  pull_request:
    branches: [ main, develop, release/* ]

jobs:
  security-check:
    name: ðŸ”’ Security Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout ÐºÐ¾Ð´
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: ðŸ“š Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      run: npm ci --include=dev
      
    - name: ðŸ”’ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      run: |
        echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð² Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑÑ…..."
        npm audit --omit=dev --audit-level=high || echo "âš ï¸ ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð² Ð¿Ñ€Ð¾Ð´ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑÑ… (Ð½Ðµ Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÐ¼ PR)"
        
    - name: ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
      run: |
        echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð² Ð² ÐºÐ¾Ð´Ðµ..."
        if grep -r "sk_live_\|pk_live_\|SUPABASE_SERVICE_ROLE_KEY" --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=.next --exclude-dir=coverage --exclude-dir=reports --exclude-dir=.github --exclude=".env.example" .; then
          echo "âŒ ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ Ð¿Ð¾Ñ‚ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÑÐµÐºÑ€ÐµÑ‚Ñ‹!"
          exit 1
        else
          echo "âœ… Ð¡ÐµÐºÑ€ÐµÑ‚Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"
        fi
        
    - name: ðŸ“¦ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ¸Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
      run: |
        echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ¸Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²..."
        npm outdated || echo "âš ï¸ ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ¸Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹"
        
    - name: ðŸ›¡ï¸ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° dev Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      run: |
        echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð² dev Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑÑ…..."
        npm audit --audit-level=moderate || echo "âš ï¸ ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð² dev Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑÑ… (Ð½Ðµ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð¾)"
        
    - name: ðŸ”§ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ
      if: failure()
      run: |
        echo "ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ..."
        npm audit fix --force || echo "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð²ÑÐµ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸"
        
    - name: ðŸ“Š ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸
      run: |
        echo "## ðŸ”’ ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ÐŸÑ€Ð¾Ð´Ð°ÐºÑˆÐ½ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸:" >> $GITHUB_STEP_SUMMARY
        npm audit --production --audit-level=high --json | jq '.vulnerabilities | length' >> $GITHUB_STEP_SUMMARY || echo "0" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Dev Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸:" >> $GITHUB_STEP_SUMMARY
        npm audit --audit-level=high --json | jq '.vulnerabilities | length' >> $GITHUB_STEP_SUMMARY || echo "0" >> $GITHUB_STEP_SUMMARY
