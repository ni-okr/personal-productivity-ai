name: ğŸ§ª Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-test:
    name: ğŸ—ï¸ Build Ñ‚ĞµÑÑ‚
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: production
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    
    steps:
    - name: ğŸ“¥ Checkout ĞºĞ¾Ğ´
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“š Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
      run: npm ci
      
    - name: ğŸ—ï¸ Build Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
      run: npm run build
      
    - name: ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞµĞºÑ€ĞµÑ‚Ğ¾Ğ²
      run: |
        echo "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ½ĞµÑ‚ ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ğ¾ Ğ·Ğ°ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‡ĞµĞ½Ğ½Ñ‹Ñ… ÑĞµĞºÑ€ĞµÑ‚Ğ¾Ğ²"
        # ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ ÑĞµĞºÑ€ĞµÑ‚Ğ¾Ğ² Ğ² ĞºĞ¾Ğ´Ğµ
        if find . -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | grep -v node_modules | grep -v .git | grep -v .next | xargs grep -l "sk_live_\|pk_live_\|SUPABASE_SERVICE_ROLE_KEY" 2>/dev/null; then
          echo "âŒ ĞĞ°Ğ¹Ğ´ĞµĞ½Ñ‹ ÑĞµĞºÑ€ĞµÑ‚Ñ‹ Ğ² ĞºĞ¾Ğ´Ğµ!"
          exit 1
        fi
        echo "âœ… Ğ¡ĞµĞºÑ€ĞµÑ‚Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹"

  unit-tests:
    name: ğŸ”§ Unit Ñ‚ĞµÑÑ‚Ñ‹
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    
    steps:
    - name: ğŸ“¥ Checkout ĞºĞ¾Ğ´
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“š Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
      run: npm ci
      
    - name: ğŸ”§ Ğ—Ğ°Ğ¿ÑƒÑĞº Unit Ñ‚ĞµÑÑ‚Ğ¾Ğ²
      run: npm run test:unit:ci
      
    - name: ğŸ“Š Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ğ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ ĞºĞ¾Ğ´Ğ°
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella

  integration-tests:
    name: ğŸ”— Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ Ñ‚ĞµÑÑ‚Ñ‹
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    
    steps:
    - name: ğŸ“¥ Checkout ĞºĞ¾Ğ´
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“š Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
      run: npm ci
      
    - name: ğŸ”— Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ñ… Ñ‚ĞµÑÑ‚Ğ¾Ğ²
      run: npm run test:integration:ci

  e2e-tests:
    name: ğŸ­ E2E Ñ‚ĞµÑÑ‚Ñ‹
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    
    steps:
    - name: ğŸ“¥ Checkout ĞºĞ¾Ğ´
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“š Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
      run: npm ci
      
    - name: ğŸ­ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Playwright Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ¾Ğ²
      run: npx playwright install --with-deps
      
    - name: ğŸ—ï¸ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
      run: npm run build
      
    - name: ğŸ­ Ğ—Ğ°Ğ¿ÑƒÑĞº E2E Ñ‚ĞµÑÑ‚Ğ¾Ğ²
      run: npm run test:e2e:ci
      
    - name: ğŸ“¸ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚Ğ¾Ğ² Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ…
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30

  security-audit:
    name: ğŸ”’ ĞÑƒĞ´Ğ¸Ñ‚ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    
    steps:
    - name: ğŸ“¥ Checkout ĞºĞ¾Ğ´
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“š Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
      run: npm ci
      
    - name: ğŸ”’ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑƒÑĞ·Ğ²Ğ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
      run: npm audit --audit-level=moderate
      
    - name: ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ»Ğ¸Ñ†ĞµĞ½Ğ·Ğ¸Ğ¹
      run: npx license-checker --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC' || echo "âš ï¸ license-checker Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"

  build-test:
    name: ğŸ—ï¸ Ğ¢ĞµÑÑ‚ ÑĞ±Ğ¾Ñ€ĞºĞ¸
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: production
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    
    steps:
    - name: ğŸ“¥ Checkout ĞºĞ¾Ğ´
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“š Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
      run: npm ci
      
    - name: ğŸ—ï¸ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
      run: npm run build
      
    - name: ğŸ§ª ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ° Ğ±Ğ°Ğ½Ğ´Ğ»Ğ°
      run: |
        echo "ğŸ“¦ Ğ Ğ°Ğ·Ğ¼ĞµÑ€ .next/static/chunks:"
        du -sh .next/static/chunks/ || echo "ĞŸĞ°Ğ¿ĞºĞ° chunks Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°"
        echo "ğŸ“Š ĞĞ±Ñ‰Ğ¸Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ .next:"
        du -sh .next/

  lint-and-format:
    name: ğŸ“ Ğ›Ğ¸Ğ½Ñ‚Ğ¸Ğ½Ğ³ Ğ¸ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    
    steps:
    - name: ğŸ“¥ Checkout ĞºĞ¾Ğ´
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“š Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
      run: npm ci
      
    - name: ğŸ” ESLint Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°
      run: npm run lint || echo "âš ï¸ ESLint Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½"
      
    - name: ğŸ¨ Prettier Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°
      run: npx prettier --check . || echo "âš ï¸ Prettier Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½"
      
    - name: ğŸ“ TypeScript Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°
      run: npx tsc --noEmit

  performance-test:
    name: âš¡ Ğ¢ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: production
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    
    steps:
    - name: ğŸ“¥ Checkout ĞºĞ¾Ğ´
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“š Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
      run: npm ci
      
    - name: ğŸ—ï¸ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
      run: npm run build
      
    - name: âš¡ Lighthouse CI
      run: |
        npm install -g @lhci/cli@0.12.x
        lhci autorun || echo "âš ï¸ Lighthouse CI Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½"

  notify-success:
    name: ğŸ‰ Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ± ÑƒÑĞ¿ĞµÑ…Ğµ
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, security-audit, build-test, lint-and-format]
    if: success()
    
    steps:
    - name: ğŸ‰ Ğ’ÑĞµ Ñ‚ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾
      run: |
        echo "âœ… Ğ’ÑĞµ Ñ‚ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!"
        echo "ğŸ”§ Unit Ñ‚ĞµÑÑ‚Ñ‹: âœ…"
        echo "ğŸ”— Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ Ñ‚ĞµÑÑ‚Ñ‹: âœ…"
        echo "ğŸ­ E2E Ñ‚ĞµÑÑ‚Ñ‹: âœ…"
        echo "ğŸ”’ ĞÑƒĞ´Ğ¸Ñ‚ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸: âœ…"
        echo "ğŸ—ï¸ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ°: âœ…"
        echo "ğŸ“ Ğ›Ğ¸Ğ½Ñ‚Ğ¸Ğ½Ğ³: âœ…"
