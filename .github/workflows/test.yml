name: üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-test:
    name: üèóÔ∏è Build —Ç–µ—Å—Ç
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: production
      NEXT_PUBLIC_SUPABASE_URL: https://zpgkzvflmgxrlgkecscg.supabase.co
      NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwZ2t6dmZsbWd4cmxna2Vjc2NnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NDM5MDcsImV4cCI6MjA3MzQxOTkwN30.usDTWCrgyMiGY1BDhy-FBy-YTSOhPNEuAm1lh1FMH5c
    
    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4
      
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci
      
    - name: üèóÔ∏è Build –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      run: npm run build

  unit-tests:
    name: üîß Unit —Ç–µ—Å—Ç—ã
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      NEXT_PUBLIC_SUPABASE_URL: https://zpgkzvflmgxrlgkecscg.supabase.co
      NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwZ2t6dmZsbWd4cmxna2Vjc2NnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NDM5MDcsImV4cCI6MjA3MzQxOTkwN30.usDTWCrgyMiGY1BDhy-FBy-YTSOhPNEuAm1lh1FMH5c
    
    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4
      
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci
      
    - name: üîß –ó–∞–ø—É—Å–∫ Unit —Ç–µ—Å—Ç–æ–≤
      run: npm run test:unit:ci
      
    - name: üìä –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –∫–æ–¥–∞
      uses: codecov/codecov-action@v3
      if: always()
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  integration-tests:
    name: üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      NEXT_PUBLIC_SUPABASE_URL: https://zpgkzvflmgxrlgkecscg.supabase.co
      NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwZ2t6dmZsbWd4cmxna2Vjc2NnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NDM5MDcsImV4cCI6MjA3MzQxOTkwN30.usDTWCrgyMiGY1BDhy-FBy-YTSOhPNEuAm1lh1FMH5c
    
    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4
      
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci
      
    - name: üîó –ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
      run: npm run test:integration:ci

  e2e-tests:
    name: üé≠ E2E —Ç–µ—Å—Ç—ã
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      NEXT_PUBLIC_SUPABASE_URL: https://zpgkzvflmgxrlgkecscg.supabase.co
      NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwZ2t6dmZsbWd4cmxna2Vjc2NnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NDM5MDcsImV4cCI6MjA3MzQxOTkwN30.usDTWCrgyMiGY1BDhy-FBy-YTSOhPNEuAm1lh1FMH5c
    
    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4
      
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci
      
    - name: üé≠ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Playwright –±—Ä–∞—É–∑–µ—Ä–æ–≤
      run: npx playwright install --with-deps
      
    - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      run: npm run build
      
    - name: üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–æ–∫ –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤
      run: |
        mkdir -p playwright-report
        mkdir -p allure-results
        echo "üìÅ –ü–∞–ø–∫–∏ –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω—ã"
      
    - name: üé≠ –ó–∞–ø—É—Å–∫ E2E —Ç–µ—Å—Ç–æ–≤
      run: |
        set +e
        npm run test:e2e:ci
        TEST_EXIT_CODE=$?
        echo "üé≠ E2E —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã —Å –∫–æ–¥–æ–º: $TEST_EXIT_CODE"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤
        if [ $TEST_EXIT_CODE -eq 0 ]; then
          echo "‚úÖ –í—Å–µ E2E —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ"
        else
          echo "‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ E2E —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–æ–≤"
        fi
        
        # –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π –∫–æ–¥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
        exit 0
      continue-on-error: true
      
    - name: üì∏ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ HTML –æ—Ç—á–µ—Ç–∞ Playwright
      run: |
        if [ -d "playwright-report" ] && [ "$(ls -A playwright-report)" ]; then
          echo "‚úÖ HTML –æ—Ç—á–µ—Ç Playwright –Ω–∞–π–¥–µ–Ω"
          ls -la playwright-report/
        else
          echo "‚ö†Ô∏è HTML –æ—Ç—á–µ—Ç Playwright –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é –ø–∞–ø–∫—É"
          mkdir -p playwright-report
          echo "–û—Ç—á–µ—Ç—ã –Ω–µ –±—ã–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã" > playwright-report/README.txt
        fi
      continue-on-error: true
      
    - name: üì∏ –ó–∞–≥—Ä—É–∑–∫–∞ HTML –æ—Ç—á–µ—Ç–∞ Playwright
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
        
    - name: üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ Allure –æ—Ç—á–µ—Ç–∞
      run: |
        if [ -d "allure-results" ] && [ "$(ls -A allure-results)" ]; then
          echo "‚úÖ Allure –æ—Ç—á–µ—Ç –Ω–∞–π–¥–µ–Ω"
          ls -la allure-results/
        else
          echo "‚ö†Ô∏è Allure –æ—Ç—á–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é –ø–∞–ø–∫—É"
          mkdir -p allure-results
          echo "Allure —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ –±—ã–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã" > allure-results/README.txt
        fi
      continue-on-error: true
      
    - name: üìä –ó–∞–≥—Ä—É–∑–∫–∞ Allure –æ—Ç—á–µ—Ç–∞
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: allure-results
        path: allure-results/
        retention-days: 30

  security-audit:
    name: üîí –ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      NEXT_PUBLIC_SUPABASE_URL: https://zpgkzvflmgxrlgkecscg.supabase.co
      NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwZ2t6dmZsbWd4cmxna2Vjc2NnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NDM5MDcsImV4cCI6MjA3MzQxOTkwN30.usDTWCrgyMiGY1BDhy-FBy-YTSOhPNEuAm1lh1FMH5c
    
    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4
      
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci
      
    - name: üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
      run: npm audit --audit-level=moderate
      
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–π
      run: npx license-checker --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC' || echo "‚ö†Ô∏è license-checker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

  build-test-advanced:
    name: üèóÔ∏è –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ç–µ—Å—Ç —Å–±–æ—Ä–∫–∏
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: production
      NEXT_PUBLIC_SUPABASE_URL: https://zpgkzvflmgxrlgkecscg.supabase.co
      NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwZ2t6dmZsbWd4cmxna2Vjc2NnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NDM5MDcsImV4cCI6MjA3MzQxOTkwN30.usDTWCrgyMiGY1BDhy-FBy-YTSOhPNEuAm1lh1FMH5c
    
    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4
      
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci
      
    - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      run: npm run build
      
    - name: üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –±–∞–Ω–¥–ª–∞
      run: |
        echo "üì¶ –†–∞–∑–º–µ—Ä .next/static/chunks:"
        du -sh .next/static/chunks/ || echo "–ü–∞–ø–∫–∞ chunks –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
        echo "üìä –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä .next:"
        du -sh .next/

  lint-and-format:
    name: üìù –õ–∏–Ω—Ç–∏–Ω–≥ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      NEXT_PUBLIC_SUPABASE_URL: https://zpgkzvflmgxrlgkecscg.supabase.co
      NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwZ2t6dmZsbWd4cmxna2Vjc2NnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NDM5MDcsImV4cCI6MjA3MzQxOTkwN30.usDTWCrgyMiGY1BDhy-FBy-YTSOhPNEuAm1lh1FMH5c
    
    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4
      
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci
      
    - name: üîç ESLint –ø—Ä–æ–≤–µ—Ä–∫–∞
      run: npm run lint || echo "‚ö†Ô∏è ESLint –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
      
    - name: üé® Prettier –ø—Ä–æ–≤–µ—Ä–∫–∞
      run: npx prettier --check . || echo "‚ö†Ô∏è Prettier –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
      
    - name: üìù TypeScript –ø—Ä–æ–≤–µ—Ä–∫–∞
      run: npx tsc --noEmit

  performance-test:
    name: ‚ö° –¢–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: production
      NEXT_PUBLIC_SUPABASE_URL: https://zpgkzvflmgxrlgkecscg.supabase.co
      NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwZ2t6dmZsbWd4cmxna2Vjc2NnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NDM5MDcsImV4cCI6MjA3MzQxOTkwN30.usDTWCrgyMiGY1BDhy-FBy-YTSOhPNEuAm1lh1FMH5c
    
    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4
      
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci
      
    - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      run: npm run build
      
    - name: ‚ö° Lighthouse CI
      run: |
        npm install -g @lhci/cli@0.12.x
        lhci autorun || echo "‚ö†Ô∏è Lighthouse CI –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"

  notify-success:
    name: üéâ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, security-audit, build-test, build-test-advanced, lint-and-format]
    if: success()
    
    steps:
    - name: üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ
      run: |
        echo "‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!"
        echo "üîß Unit —Ç–µ—Å—Ç—ã: ‚úÖ"
        echo "üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã: ‚úÖ"
        echo "üé≠ E2E —Ç–µ—Å—Ç—ã: ‚úÖ"
        echo "üîí –ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: ‚úÖ"
        echo "üèóÔ∏è –°–±–æ—Ä–∫–∞: ‚úÖ"
        echo "üìù –õ–∏–Ω—Ç–∏–Ω–≥: ‚úÖ"
