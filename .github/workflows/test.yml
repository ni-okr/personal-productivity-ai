name: üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-test:
    name: üèóÔ∏è Build —Ç–µ—Å—Ç
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: production
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    
    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4
      
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci
      
    - name: üèóÔ∏è Build –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      run: npm run build
      
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤
      run: |
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–µ—Ç —Å–ª—É—á–∞–π–Ω–æ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤"
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞—Å—Ç–æ—è—â–∏–µ —Å–µ–∫—Ä–µ—Ç—ã, –∏—Å–∫–ª—é—á–∞—è —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        if grep -r "sk_live_" . --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=.next --exclude-dir=coverage --exclude-dir=reports; then
          echo "‚ùå –ù–∞–π–¥–µ–Ω—ã live —Å–µ–∫—Ä–µ—Ç—ã!"
          exit 1
        fi
        if grep -r "pk_live_" . --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=.next --exclude-dir=coverage --exclude-dir=reports; then
          echo "‚ùå –ù–∞–π–¥–µ–Ω—ã live —Å–µ–∫—Ä–µ—Ç—ã!"
          exit 1
        fi
        if grep -r "SUPABASE_SERVICE_ROLE_KEY" . --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=.next --exclude-dir=coverage --exclude-dir=reports; then
          echo "‚ùå –ù–∞–π–¥–µ–Ω—ã service role –∫–ª—é—á–∏!"
          exit 1
        fi
        echo "‚úÖ –°–µ–∫—Ä–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

  unit-tests:
    name: üîß Unit —Ç–µ—Å—Ç—ã
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    
    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4
      
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci
      
    - name: üîß –ó–∞–ø—É—Å–∫ Unit —Ç–µ—Å—Ç–æ–≤
      run: npm run test:unit:ci
      
    - name: üìä –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –∫–æ–¥–∞
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella

  integration-tests:
    name: üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    
    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4
      
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci
      
    - name: üîó –ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
      run: npm run test:integration:ci

  e2e-tests:
    name: üé≠ E2E —Ç–µ—Å—Ç—ã
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    
    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4
      
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci
      
    - name: üé≠ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Playwright –±—Ä–∞—É–∑–µ—Ä–æ–≤
      run: npx playwright install --with-deps
      
    - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      run: npm run build
      
    - name: üé≠ –ó–∞–ø—É—Å–∫ E2E —Ç–µ—Å—Ç–æ–≤
      run: npm run test:e2e:ci
      
    - name: üì∏ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30

  security-audit:
    name: üîí –ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    
    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4
      
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci
      
    - name: üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
      run: npm audit --audit-level=moderate
      
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–π
      run: npx license-checker --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC' || echo "‚ö†Ô∏è license-checker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

  build-test:
    name: üèóÔ∏è –¢–µ—Å—Ç —Å–±–æ—Ä–∫–∏
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: production
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    
    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4
      
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci
      
    - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      run: npm run build
      
    - name: üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –±–∞–Ω–¥–ª–∞
      run: |
        echo "üì¶ –†–∞–∑–º–µ—Ä .next/static/chunks:"
        du -sh .next/static/chunks/ || echo "–ü–∞–ø–∫–∞ chunks –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
        echo "üìä –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä .next:"
        du -sh .next/

  lint-and-format:
    name: üìù –õ–∏–Ω—Ç–∏–Ω–≥ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    
    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4
      
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci
      
    - name: üîç ESLint –ø—Ä–æ–≤–µ—Ä–∫–∞
      run: npm run lint || echo "‚ö†Ô∏è ESLint –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
      
    - name: üé® Prettier –ø—Ä–æ–≤–µ—Ä–∫–∞
      run: npx prettier --check . || echo "‚ö†Ô∏è Prettier –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
      
    - name: üìù TypeScript –ø—Ä–æ–≤–µ—Ä–∫–∞
      run: npx tsc --noEmit

  performance-test:
    name: ‚ö° –¢–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: production
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    
    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4
      
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci
      
    - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      run: npm run build
      
    - name: ‚ö° Lighthouse CI
      run: |
        npm install -g @lhci/cli@0.12.x
        lhci autorun || echo "‚ö†Ô∏è Lighthouse CI –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"

  notify-success:
    name: üéâ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, security-audit, build-test, lint-and-format]
    if: success()
    
    steps:
    - name: üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ
      run: |
        echo "‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!"
        echo "üîß Unit —Ç–µ—Å—Ç—ã: ‚úÖ"
        echo "üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã: ‚úÖ"
        echo "üé≠ E2E —Ç–µ—Å—Ç—ã: ‚úÖ"
        echo "üîí –ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: ‚úÖ"
        echo "üèóÔ∏è –°–±–æ—Ä–∫–∞: ‚úÖ"
        echo "üìù –õ–∏–Ω—Ç–∏–Ω–≥: ‚úÖ"
