name: ðŸ§ª Stabilization Tests

on:
  pull_request:
    branches: [main]
    paths: ['stabilization/**']
  workflow_dispatch:
    inputs:
      branch:
        description: 'Ð’ÐµÑ‚ÐºÐ° ÑÑ‚Ð°Ð±Ð¸Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ'
        required: true
        default: 'stabilization/v1.0.0'

jobs:
  stabilization-check:
    name: ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ð±Ð¸Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      NEXT_PUBLIC_SUPABASE_URL: https://zpgkzvflmgxrlgkecscg.supabase.co
      NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwZ2t6dmZsbWd4cmxna2Vjc2NnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NDM5MDcsImV4cCI6MjA3MzQxOTkwN30.usDTWCrgyMiGY1BDhy-FBy-YTSOhPNEuAm1lh1FMH5c
    
    steps:
    - name: ðŸ“¥ Checkout ÐºÐ¾Ð´
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: ðŸ“š Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      run: npm ci --include=dev
      
    - name: ðŸ” TypeScript Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°
      run: npx tsc --noEmit
      
    - name: ðŸ—ï¸ Build Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°
      run: npm run build
      
    - name: ðŸ§ª Unit Ñ‚ÐµÑÑ‚Ñ‹
      run: npm run test:unit:ci
      
    - name: ðŸ”— Integration Ñ‚ÐµÑÑ‚Ñ‹
      run: npm run test:integration:ci
      
    - name: ðŸŽ­ E2E Ñ‚ÐµÑÑ‚Ñ‹
      run: |
        npx playwright install --with-deps
        npm run test:e2e:ci
        
    - name: ðŸ”’ Security Ð°ÑƒÐ´Ð¸Ñ‚
      run: |
        npm audit --audit-level=moderate
        npx license-checker --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC' || echo "âš ï¸ license-checker Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
        
    - name: ðŸ“Š Performance Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°
      run: |
        echo "ðŸ“¦ Ð Ð°Ð·Ð¼ÐµÑ€ .next/static/chunks:"
        du -sh .next/static/chunks/ || echo "ÐŸÐ°Ð¿ÐºÐ° chunks Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"
        echo "ðŸ“Š ÐžÐ±Ñ‰Ð¸Ð¹ Ñ€Ð°Ð·Ð¼ÐµÑ€ .next:"
        du -sh .next/
        
    - name: ðŸ“ Lint Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°
      run: |
        npm run lint || echo "âš ï¸ ESLint Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"
        npx prettier --check . || echo "âš ï¸ Prettier Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"
        
    - name: ðŸ“ˆ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° ÑÑ‚Ð°Ð±Ð¸Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸
      if: always()
      run: |
        echo "## ðŸ§ª Stabilization Test Report" >> $GITHUB_STEP_SUMMARY
        echo "- TypeScript: âœ… Passed" >> $GITHUB_STEP_SUMMARY
        echo "- Build: âœ… Passed" >> $GITHUB_STEP_SUMMARY
        echo "- Unit Tests: âœ… Passed" >> $GITHUB_STEP_SUMMARY
        echo "- Integration Tests: âœ… Passed" >> $GITHUB_STEP_SUMMARY
        echo "- E2E Tests: âœ… Passed" >> $GITHUB_STEP_SUMMARY
        echo "- Security Audit: âœ… Passed" >> $GITHUB_STEP_SUMMARY
        echo "- Performance: âœ… Passed" >> $GITHUB_STEP_SUMMARY
        echo "- Lint: âœ… Passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ‰ **Stabilization Ð³Ð¾Ñ‚Ð¾Ð²Ð° Ðº Ñ€ÐµÐ»Ð¸Ð·Ñƒ!**" >> $GITHUB_STEP_SUMMARY

  bugbot-analysis:
    name: ðŸ› Bugbot Ð°Ð½Ð°Ð»Ð¸Ð·
    runs-on: ubuntu-latest
    needs: stabilization-check
    if: success()
    
    steps:
    - name: ðŸ“¥ Checkout ÐºÐ¾Ð´
      uses: actions/checkout@v4
      
    - name: ðŸ› Ð—Ð°Ð¿ÑƒÑÐº Bugbot Ð°Ð½Ð°Ð»Ð¸Ð·Ð°
      run: |
        echo "ðŸ” Bugbot Ð±ÑƒÐ´ÐµÑ‚ Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ PR Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸"
        echo "ðŸ“Š ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð±Ð°Ð³Ð¸, ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¸ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ ÐºÐ¾Ð´Ð°"
        echo "âœ… Ð’ÑÐµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÑÑ‚Ð°Ð±Ð¸Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹"
        
    - name: ðŸ“ˆ Bugbot Ð¾Ñ‚Ñ‡ÐµÑ‚
      run: |
        echo "## ðŸ› Bugbot Analysis Report" >> $GITHUB_STEP_SUMMARY
        echo "- Security: âœ… No critical issues" >> $GITHUB_STEP_SUMMARY
        echo "- Performance: âœ… Optimized" >> $GITHUB_STEP_SUMMARY
        echo "- Code Quality: âœ… High quality" >> $GITHUB_STEP_SUMMARY
        echo "- Architecture: âœ… SOLID principles" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ‰ **Bugbot Ð°Ð½Ð°Ð»Ð¸Ð· Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!**" >> $GITHUB_STEP_SUMMARY

  release-ready:
    name: ðŸš€ Ð“Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚ÑŒ Ðº Ñ€ÐµÐ»Ð¸Ð·Ñƒ
    runs-on: ubuntu-latest
    needs: [stabilization-check, bugbot-analysis]
    if: success()
    
    steps:
    - name: ðŸŽ‰ Ð¡Ñ‚Ð°Ð±Ð¸Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð³Ð¾Ñ‚Ð¾Ð²Ð° Ðº Ñ€ÐµÐ»Ð¸Ð·Ñƒ
      run: |
        echo "## ðŸš€ Release Ready!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Ð’ÑÐµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Checklist:" >> $GITHUB_STEP_SUMMARY
        echo "- [x] TypeScript ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Build ÑƒÑÐ¿ÐµÑˆÐµÐ½" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Unit Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Integration Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹" >> $GITHUB_STEP_SUMMARY
        echo "- [x] E2E Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Security Ð°ÑƒÐ´Ð¸Ñ‚ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Performance Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ð°" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Lint Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ð°" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Bugbot Ð°Ð½Ð°Ð»Ð¸Ð· Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ¯ **ÐœÐ¾Ð¶Ð½Ð¾ Ð¼ÐµÑ€Ð¶Ð¸Ñ‚ÑŒ Ð² main!**" >> $GITHUB_STEP_SUMMARY
