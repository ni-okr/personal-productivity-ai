name: ðŸš€ Release Stabilization

on:
  pull_request:
    branches: [main]
    paths: ['release/**']
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version (e.g., v1.3.0)'
        required: true
        default: 'v1.3.0'

env:
  NODE_VERSION: '18'
  NPM_CACHE_KEY: 'npm-cache-${{ hashFiles('**/package-lock.json') }}'

jobs:
  # ðŸ” ÐŸÑ€ÐµÐ´Ð²Ð°Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
  pre-checks:
    name: ðŸ” Pre-checks
    runs-on: ubuntu-latest
    outputs:
      should-run-tests: ${{ steps.check.outputs.should-run-tests }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Check changes
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should-run-tests=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² release/ Ð²ÐµÑ‚ÐºÐµ
            if git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -q "^release/"; then
              echo "should-run-tests=true" >> $GITHUB_OUTPUT
            else
              echo "should-run-tests=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "should-run-tests=true" >> $GITHUB_OUTPUT
          fi

  # ðŸ§ª Unit Ñ‚ÐµÑÑ‚Ñ‹
  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: pre-checks
    if: needs.pre-checks.outputs.should-run-tests == 'true'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ§ª Run unit tests
        run: npm run test:unit
        env:
          NODE_ENV: test
          NEXT_PUBLIC_DEV_MODE: 'true'
          NEXT_PUBLIC_DISABLE_EMAIL: 'true'
          TEST_EMAIL_DOMAIN: '@example.test'

      - name: ðŸ“Š Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unit
          name: unit-tests

  # ðŸ”— Integration Ñ‚ÐµÑÑ‚Ñ‹
  integration-tests:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: pre-checks
    if: needs.pre-checks.outputs.should-run-tests == 'true'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ§ª Run integration tests
        run: npm run test:integration
        env:
          NODE_ENV: test
          NEXT_PUBLIC_DEV_MODE: 'true'
          NEXT_PUBLIC_DISABLE_EMAIL: 'true'
          TEST_EMAIL_DOMAIN: '@example.test'

  # ðŸŽ­ E2E Ñ‚ÐµÑÑ‚Ñ‹
  e2e-tests:
    name: ðŸŽ­ E2E Tests
    runs-on: ubuntu-latest
    needs: pre-checks
    if: needs.pre-checks.outputs.should-run-tests == 'true'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸŽ­ Install Playwright
        run: npx playwright install --with-deps

      - name: ðŸ§ª Run E2E tests
        run: npm run test:e2e
        env:
          NODE_ENV: test
          NEXT_PUBLIC_DEV_MODE: 'true'
          NEXT_PUBLIC_DISABLE_EMAIL: 'true'
          TEST_EMAIL_DOMAIN: '@example.test'

      - name: ðŸ“Š Upload E2E results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  # ðŸ—ï¸ Build Ñ‚ÐµÑÑ‚Ñ‹
  build-tests:
    name: ðŸ—ï¸ Build Tests
    runs-on: ubuntu-latest
    needs: pre-checks
    if: needs.pre-checks.outputs.should-run-tests == 'true'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build project
        run: npm run build
        env:
          NODE_ENV: production

      - name: ðŸ“Š Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: .next/
          retention-days: 7

  # ðŸ”’ Security Ð°ÑƒÐ´Ð¸Ñ‚
  security-audit:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    needs: pre-checks
    if: needs.pre-checks.outputs.should-run-tests == 'true'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ”’ Run security audit
        run: npm audit --audit-level high

      - name: ðŸ” Run CodeQL analysis
        uses: github/codeql-action/analyze@v2
        with:
          languages: javascript

  # ðŸ“ Lint Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
  lint-checks:
    name: ðŸ“ Lint Checks
    runs-on: ubuntu-latest
    needs: pre-checks
    if: needs.pre-checks.outputs.should-run-tests == 'true'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ“ Run ESLint
        run: npm run lint

      - name: ðŸŽ¨ Run Prettier check
        run: npm run format:check

      - name: ðŸ”§ Run TypeScript check
        run: npm run type-check

  # âš¡ Performance Ñ‚ÐµÑÑ‚Ñ‹
  performance-tests:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: pre-checks
    if: needs.pre-checks.outputs.should-run-tests == 'true'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build project
        run: npm run build
        env:
          NODE_ENV: production

      - name: âš¡ Run Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.12.x
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  # ðŸ“Š Ð¡Ð²Ð¾Ð´Ð½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚
  summary:
    name: ðŸ“Š Summary Report
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, build-tests, security-audit, lint-checks, performance-tests]
    if: always()
    steps:
      - name: ðŸ“Š Generate summary
        run: |
          echo "## ðŸš€ Release Stabilization Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Tests | ${{ needs.build-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Audit | ${{ needs.security-audit.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint Checks | ${{ needs.lint-checks.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance Tests | ${{ needs.performance-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Overall Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.unit-tests.result }}" == "success" && "${{ needs.integration-tests.result }}" == "success" && "${{ needs.e2e-tests.result }}" == "success" && "${{ needs.build-tests.result }}" == "success" && "${{ needs.security-audit.result }}" == "success" && "${{ needs.lint-checks.result }}" == "success" && "${{ needs.performance-tests.result }}" == "success" ]]; then
            echo "ðŸŽ‰ **All tests passed! Release is ready for production.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Some tests failed. Please fix issues before releasing.**" >> $GITHUB_STEP_SUMMARY
          fi

  # ðŸš€ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ñ€ÐµÐ»Ð¸Ð· (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ main)
  auto-release:
    name: ðŸš€ Auto Release
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, build-tests, security-audit, lint-checks, performance-tests]
    if: |
      github.ref == 'refs/heads/main' && 
      github.event_name == 'pull_request' && 
      github.event.pull_request.merged == true &&
      needs.unit-tests.result == 'success' &&
      needs.integration-tests.result == 'success' &&
      needs.e2e-tests.result == 'success' &&
      needs.build-tests.result == 'success' &&
      needs.security-audit.result == 'success' &&
      needs.lint-checks.result == 'success' &&
      needs.performance-tests.result == 'success'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ·ï¸ Get version
        id: version
        run: |
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¸Ð· package.json
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: ðŸš€ Create release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          release_name: Release ${{ steps.version.outputs.tag }}
          body: |
            ## ðŸŽ‰ Release ${{ steps.version.outputs.tag }}
            
            ### âœ… What's included:
            - All tests passed âœ…
            - Security audit passed âœ…
            - Performance tests passed âœ…
            - Build successful âœ…
            
            ### ðŸš€ Ready for production!
          draft: false
          prerelease: false