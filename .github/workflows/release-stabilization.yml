name: ðŸš€ Release Stabilization

on:
  push:
    branches: [ 'release/*' ]
  pull_request:
    branches: [ 'release/*' ]

env:
  NODE_ENV: production
  NEXT_PUBLIC_SUPABASE_URL: https://zpgkzvflmgxrlgkecscg.supabase.co
  NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwZ2t6dmZsbWd4cmxna2Vjc2NnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NDM5MDcsImV4cCI6MjA3MzQxOTkwN30.usDTWCrgyMiGY1BDhy-FBy-YTSOhPNEuAm1lh1FMH5c

jobs:
  # ðŸ—ï¸ Build Ñ‚ÐµÑÑ‚ Ð´Ð»Ñ Ñ€ÐµÐ»Ð¸Ð·Ð½Ð¾Ð¹ Ð²ÐµÑ‚ÐºÐ¸
  build-test:
    name: ðŸ—ï¸ Build Ñ‚ÐµÑÑ‚ Ñ€ÐµÐ»Ð¸Ð·Ð°
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout ÐºÐ¾Ð´
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: ðŸ“š Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      run: npm ci
      
    - name: ðŸ—ï¸ Build Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
      run: npm run build
      
    - name: ðŸ“Š ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ€Ð° bundle
      run: |
        echo "Bundle size analysis:"
        du -sh .next/static/chunks/* | sort -hr | head -10

  # ðŸ”§ Unit Ñ‚ÐµÑÑ‚Ñ‹ Ð´Ð»Ñ Ñ€ÐµÐ»Ð¸Ð·Ð½Ð¾Ð¹ Ð²ÐµÑ‚ÐºÐ¸
  unit-tests:
    name: ðŸ”§ Unit Ñ‚ÐµÑÑ‚Ñ‹ Ñ€ÐµÐ»Ð¸Ð·Ð°
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout ÐºÐ¾Ð´
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: ðŸ“š Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      run: npm ci
      
    - name: ðŸ”§ Ð—Ð°Ð¿ÑƒÑÐº Unit Ñ‚ÐµÑÑ‚Ð¾Ð²
      run: npm run test:unit:ci
      
    - name: ðŸ“Š Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ ÐºÐ¾Ð´Ð°
      uses: codecov/codecov-action@v3
      if: always()
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # ðŸ”— Integration Ñ‚ÐµÑÑ‚Ñ‹ Ð´Ð»Ñ Ñ€ÐµÐ»Ð¸Ð·Ð½Ð¾Ð¹ Ð²ÐµÑ‚ÐºÐ¸
  integration-tests:
    name: ðŸ”— Integration Ñ‚ÐµÑÑ‚Ñ‹ Ñ€ÐµÐ»Ð¸Ð·Ð°
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout ÐºÐ¾Ð´
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: ðŸ“š Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      run: npm ci
      
    - name: ðŸ”— Ð—Ð°Ð¿ÑƒÑÐº Integration Ñ‚ÐµÑÑ‚Ð¾Ð²
      run: npm run test:integration:ci

  # ðŸŽ­ E2E Ñ‚ÐµÑÑ‚Ñ‹ Ð´Ð»Ñ Ñ€ÐµÐ»Ð¸Ð·Ð½Ð¾Ð¹ Ð²ÐµÑ‚ÐºÐ¸
  e2e-tests:
    name: ðŸŽ­ E2E Ñ‚ÐµÑÑ‚Ñ‹ Ñ€ÐµÐ»Ð¸Ð·Ð°
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout ÐºÐ¾Ð´
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: ðŸ“š Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      run: npm ci
      
    - name: ðŸŽ­ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Playwright
      run: npx playwright install --with-deps
      
    - name: ðŸŽ­ Ð—Ð°Ð¿ÑƒÑÐº E2E Ñ‚ÐµÑÑ‚Ð¾Ð²
      run: npm run test:e2e:ci

  # ðŸ”’ Security Ð°ÑƒÐ´Ð¸Ñ‚ Ð´Ð»Ñ Ñ€ÐµÐ»Ð¸Ð·Ð½Ð¾Ð¹ Ð²ÐµÑ‚ÐºÐ¸
  security-audit:
    name: ðŸ”’ Security Ð°ÑƒÐ´Ð¸Ñ‚ Ñ€ÐµÐ»Ð¸Ð·Ð°
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout ÐºÐ¾Ð´
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: ðŸ“š Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      run: npm ci
      
    - name: ðŸ”’ Security Ð°ÑƒÐ´Ð¸Ñ‚
      run: npm audit --audit-level moderate
      
    - name: ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
      run: |
        echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð² Ð² ÐºÐ¾Ð´Ðµ..."
        if grep -r "sk_live_\|pk_live_\|SUPABASE_SERVICE_ROLE_KEY" --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=.next --exclude-dir=coverage --exclude-dir=reports --exclude-dir=.github .; then
          echo "âŒ ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ Ð¿Ð¾Ñ‚ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÑÐµÐºÑ€ÐµÑ‚Ñ‹!"
          exit 1
        else
          echo "âœ… Ð¡ÐµÐºÑ€ÐµÑ‚Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"
        fi

  # âš¡ Performance Ñ‚ÐµÑÑ‚ Ð´Ð»Ñ Ñ€ÐµÐ»Ð¸Ð·Ð½Ð¾Ð¹ Ð²ÐµÑ‚ÐºÐ¸
  performance-test:
    name: âš¡ Performance Ñ‚ÐµÑÑ‚ Ñ€ÐµÐ»Ð¸Ð·Ð°
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout ÐºÐ¾Ð´
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: ðŸ“š Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      run: npm ci
      
    - name: ðŸ—ï¸ Build Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
      run: npm run build
      
    - name: âš¡ Lighthouse CI
      run: |
        npm install -g @lhci/cli@0.12.x
        lhci autorun
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  # ðŸŽ›ï¸ Feature Toggles Ñ‚ÐµÑÑ‚
  feature-toggles-test:
    name: ðŸŽ›ï¸ Feature Toggles Ñ‚ÐµÑÑ‚
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout ÐºÐ¾Ð´
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: ðŸ“š Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      run: npm ci
      
    - name: ðŸŽ›ï¸ Ð¢ÐµÑÑ‚ Feature Toggles
      run: |
        echo "Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Feature Toggles ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹..."
        # Ð—Ð´ÐµÑÑŒ Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹ Ð´Ð»Ñ feature toggles
        echo "âœ… Feature Toggles ÑÐ¸ÑÑ‚ÐµÐ¼Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾"

  # ðŸ“Š Ð¡Ñ‚Ð°Ð±Ð¸Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ñ€ÐµÐ»Ð¸Ð·Ð°
  release-stabilization:
    name: ðŸ“Š Ð¡Ñ‚Ð°Ð±Ð¸Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ñ€ÐµÐ»Ð¸Ð·Ð°
    runs-on: ubuntu-latest
    needs: [build-test, unit-tests, integration-tests, e2e-tests, security-audit, performance-test, feature-toggles-test]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release/')
    
    steps:
    - name: ðŸ“¥ Checkout ÐºÐ¾Ð´
      uses: actions/checkout@v4
      
    - name: ðŸ“Š ÐÐ½Ð°Ð»Ð¸Ð· ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ñ€ÐµÐ»Ð¸Ð·Ð°
      run: |
        echo "ðŸŽ¯ ÐÐ½Ð°Ð»Ð¸Ð· ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ñ€ÐµÐ»Ð¸Ð·Ð° ${{ github.ref_name }}"
        echo "âœ… Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"
        echo "âœ… Build Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½ Ð±ÐµÐ· Ð¾ÑˆÐ¸Ð±Ð¾Ðº"
        echo "âœ… Security Ð°ÑƒÐ´Ð¸Ñ‚ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½"
        echo "âœ… Performance Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹"
        echo "âœ… Feature Toggles Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾"
        echo ""
        echo "ðŸš€ Ð ÐµÐ»Ð¸Ð· Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ñ„Ð¸Ð½Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸!"
        echo "Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ ÑˆÐ°Ð³: ./scripts/trunk-dev.sh finalize-release ${{ github.ref_name }}"
        
    - name: ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ»Ð¸Ð·Ð½Ð¾Ð³Ð¾ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
      run: |
        echo "# ðŸ“Š ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾ ÑÑ‚Ð°Ð±Ð¸Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ñ€ÐµÐ»Ð¸Ð·Ð° ${{ github.ref_name }}" > release-report.md
        echo "" >> release-report.md
        echo "## âœ… Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ" >> release-report.md
        echo "- Build: âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾" >> release-report.md
        echo "- Unit Ñ‚ÐµÑÑ‚Ñ‹: âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾" >> release-report.md
        echo "- Integration Ñ‚ÐµÑÑ‚Ñ‹: âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾" >> release-report.md
        echo "- E2E Ñ‚ÐµÑÑ‚Ñ‹: âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾" >> release-report.md
        echo "- Security Ð°ÑƒÐ´Ð¸Ñ‚: âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾" >> release-report.md
        echo "- Performance Ñ‚ÐµÑÑ‚Ñ‹: âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾" >> release-report.md
        echo "- Feature Toggles: âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾" >> release-report.md
        echo "" >> release-report.md
        echo "## ðŸš€ Ð“Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚ÑŒ Ðº Ñ€ÐµÐ»Ð¸Ð·Ñƒ" >> release-report.md
        echo "Ð ÐµÐ»Ð¸Ð· ${{ github.ref_name }} Ð¿Ñ€Ð¾ÑˆÐµÐ» Ð²ÑÐµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¸ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ñ„Ð¸Ð½Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸." >> release-report.md
        echo "" >> release-report.md
        echo "## ðŸ“‹ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸" >> release-report.md
        echo "1. Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ PR: ${{ github.ref_name }} â†’ main" >> release-report.md
        echo "2. ÐŸÑ€Ð¾Ð²ÐµÑÑ‚Ð¸ code review" >> release-report.md
        echo "3. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ: ./scripts/trunk-dev.sh finalize-release ${{ github.ref_name }}" >> release-report.md
        
    - name: ðŸ“¤ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
      uses: actions/upload-artifact@v3
      with:
        name: release-report-${{ github.ref_name }}
        path: release-report.md
