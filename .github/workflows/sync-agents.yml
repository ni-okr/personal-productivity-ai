name: ðŸ¤– Sync Background Agents

on:
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ°Ð¶Ð´Ñ‹Ðµ 10 Ð¼Ð¸Ð½ÑƒÑ‚
    - cron: '*/10 * * * *'
  workflow_dispatch:
    # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
    inputs:
      branch:
        description: 'Ð’ÐµÑ‚ÐºÐ° Ð°Ð³ÐµÐ½Ñ‚Ð° Ð´Ð»Ñ Ð¼ÐµÑ€Ð¶Ð°'
        required: false
        default: ''

jobs:
  sync-agents:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ”„ Fetch all branches
        run: |
          git fetch --all
          git branch -a
      
      - name: ðŸ” Check for agent branches
        id: check-branches
        run: |
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð²ÐµÑ‚Ð¾Ðº Ð°Ð³ÐµÐ½Ñ‚Ð¾Ð²
          AGENT_BRANCHES=$(git branch -r | grep -E "(agent|fix|feature)" | grep -v "origin/main" | head -5)
          
          if [ -z "$AGENT_BRANCHES" ]; then
            echo "branches=" >> $GITHUB_OUTPUT
            echo "âœ… ÐÐµÑ‚ Ð½Ð¾Ð²Ñ‹Ñ… Ð²ÐµÑ‚Ð¾Ðº Ð°Ð³ÐµÐ½Ñ‚Ð¾Ð²"
          else
            echo "branches=$AGENT_BRANCHES" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ Ð²ÐµÑ‚ÐºÐ¸ Ð°Ð³ÐµÐ½Ñ‚Ð¾Ð²:"
            echo "$AGENT_BRANCHES"
          fi
      
      - name: ðŸ”„ Auto-merge agent branches
        if: steps.check-branches.outputs.branches != ''
        run: |
          for branch in ${{ steps.check-branches.outputs.branches }}; do
            echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²ÐµÑ‚ÐºÑƒ: $branch"
            
            # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚ Ð²ÐµÑ‚ÐºÐ¸
            LAST_COMMIT=$(git log -1 --format="%H" $branch)
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐµÑÑ‚ÑŒ Ð»Ð¸ ÑÑ‚Ð¾Ñ‚ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚ Ð² main
            if ! git merge-base --is-ancestor $LAST_COMMIT main; then
              echo "ðŸ†• ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ Ð½Ð¾Ð²Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² $branch"
              
              # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¾ÑÑŒ
              echo "ðŸ“ Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ:"
              git log --oneline main..$branch
              
              # ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¼ÐµÑ€Ð¶Ð¸Ð¼ (Ð¼Ð¾Ð¶Ð½Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ)
              echo "ðŸ”„ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¼ÐµÑ€Ð¶Ð¸Ð¼ $branch Ð² main..."
              git merge $branch --no-edit
              
              if [ $? -eq 0 ]; then
                echo "âœ… Ð’ÐµÑ‚ÐºÐ° $branch ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¼ÐµÑ€Ð¶ÐµÐ½Ð°"
              else
                echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¼ÐµÑ€Ð¶Ðµ $branch"
              fi
            else
              echo "âœ… Ð’ÐµÑ‚ÐºÐ° $branch ÑƒÐ¶Ðµ Ð² main"
            fi
          done
      
      - name: ðŸš€ Push changes
        if: steps.check-branches.outputs.branches != ''
        run: |
          git push origin main
          echo "ðŸŽ‰ Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð² main"
      
      - name: ðŸ“Š Create summary
        if: always()
        run: |
          echo "## ðŸ¤– Sync Agents Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Branches checked**: ${{ steps.check-branches.outputs.branches }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
