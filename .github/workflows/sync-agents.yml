name: 🤖 Sync Background Agents

on:
  schedule:
    # Запускаем каждые 10 минут
    - cron: '*/10 * * * *'
  workflow_dispatch:
    # Ручной запуск
    inputs:
      branch:
        description: 'Ветка агента для мержа'
        required: false
        default: ''

jobs:
  sync-agents:
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 🔄 Fetch all branches
        run: |
          git fetch --all
          git branch -a
      
      - name: 🔍 Check for agent branches
        id: check-branches
        run: |
          # Получаем список веток агентов
          AGENT_BRANCHES=$(git branch -r | grep -E "(agent|fix|feature)" | grep -v "origin/main" | head -5)
          
          if [ -z "$AGENT_BRANCHES" ]; then
            echo "branches=" >> $GITHUB_OUTPUT
            echo "✅ Нет новых веток агентов"
          else
            echo "branches=$AGENT_BRANCHES" >> $GITHUB_OUTPUT
            echo "📋 Найдены ветки агентов:"
            echo "$AGENT_BRANCHES"
          fi
      
      - name: 🔄 Auto-merge agent branches
        if: steps.check-branches.outputs.branches != ''
        run: |
          for branch in ${{ steps.check-branches.outputs.branches }}; do
            echo "🔍 Проверяем ветку: $branch"
            
            # Получаем последний коммит ветки
            LAST_COMMIT=$(git log -1 --format="%H" $branch)
            
            # Проверяем есть ли этот коммит в main
            if ! git merge-base --is-ancestor $LAST_COMMIT main; then
              echo "🆕 Найдены новые изменения в $branch"
              
              # Показываем что изменилось
              echo "📝 Изменения:"
              git log --oneline main..$branch
              
              # Автоматически мержим (можно настроить условия)
              echo "🔄 Автоматически мержим $branch в main..."
              git merge $branch --no-edit
              
              if [ $? -eq 0 ]; then
                echo "✅ Ветка $branch успешно смержена"
              else
                echo "❌ Ошибка при мерже $branch"
              fi
            else
              echo "✅ Ветка $branch уже в main"
            fi
          done
      
      - name: 🚀 Push changes
        if: steps.check-branches.outputs.branches != ''
        run: |
          git push origin main
          echo "🎉 Изменения отправлены в main"
      
      - name: 📊 Create summary
        if: always()
        run: |
          echo "## 🤖 Sync Agents Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Branches checked**: ${{ steps.check-branches.outputs.branches }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
