#!/bin/bash

# ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Ñ–æ–Ω–æ–≤—ã–º–∏ –∞–≥–µ–Ω—Ç–∞–º–∏
# –ó–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –¥–ª—è –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

echo "üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –æ—Ç —Ñ–æ–Ω–æ–≤—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤..."

# –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –≤—Å–µ –≤–µ—Ç–∫–∏
git fetch --all

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤–µ—Ç–æ–∫ –∞–≥–µ–Ω—Ç–æ–≤
AGENT_BRANCHES=$(git branch -r | grep -E "(agent|fix|feature)" | grep -v "origin/main")

if [ -z "$AGENT_BRANCHES" ]; then
    echo "‚úÖ –ù–µ—Ç –Ω–æ–≤—ã—Ö –≤–µ—Ç–æ–∫ –∞–≥–µ–Ω—Ç–æ–≤"
    exit 0
fi

echo "üìã –ù–∞–π–¥–µ–Ω—ã –≤–µ—Ç–∫–∏ –∞–≥–µ–Ω—Ç–æ–≤:"
echo "$AGENT_BRANCHES"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –≤–µ—Ç–∫—É –Ω–∞ –Ω–æ–≤—ã–µ –∫–æ–º–º–∏—Ç—ã
for branch in $AGENT_BRANCHES; do
    echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ç–∫—É: $branch"
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç –≤–µ—Ç–∫–∏
    LAST_COMMIT=$(git log -1 --format="%H" $branch)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —ç—Ç–æ—Ç –∫–æ–º–º–∏—Ç –≤ main
    if ! git merge-base --is-ancestor $LAST_COMMIT main; then
        echo "üÜï –ù–∞–π–¥–µ–Ω—ã –Ω–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ $branch"
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
        echo "üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è:"
        git log --oneline main..$branch
        
        # –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á—Ç–æ –¥–µ–ª–∞—Ç—å
        echo "‚ùì –•–æ—Ç–∏—Ç–µ —Å–º–µ—Ä–∂–∏—Ç—å $branch –≤ main? (y/n)"
        read -r response
        
        if [[ "$response" =~ ^[Yy]$ ]]; then
            echo "üîÑ –ú–µ—Ä–∂–∏–º $branch –≤ main..."
            git merge $branch
            echo "‚úÖ –í–µ—Ç–∫–∞ $branch —É—Å–ø–µ—à–Ω–æ —Å–º–µ—Ä–∂–µ–Ω–∞"
        else
            echo "‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º $branch"
        fi
    else
        echo "‚úÖ –í–µ—Ç–∫–∞ $branch —É–∂–µ –≤ main"
    fi
done

echo "üéâ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
