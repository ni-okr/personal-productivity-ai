// üß™ Unit —Ç–µ—Å—Ç—ã –¥–ª—è mock —Ä–µ–∂–∏–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫
import {
    addMockSubscription,
    clearMockSubscriptions,
    mockCancelSubscription,
    mockCreateSubscription,
    mockGetSubscription,
    mockGetSubscriptionPlans,
    mockGetSubscriptionStatus,
    mockUpdateSubscription
} from '@/lib/subscription-mock'
import { Subscription, SubscriptionTier } from '@/types'

// Mock console.log –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–æ–≤
let mockConsoleLog: jest.SpyInstance

describe('Subscription Mock Functions', () => {
    const mockUserId = 'mock-user-1'

    beforeEach(() => {
        clearMockSubscriptions()
        mockConsoleLog = jest.spyOn(console, 'log').mockImplementation()
    })

    afterEach(() => {
        mockConsoleLog.mockRestore()
    })

    describe('mockGetSubscription', () => {
        it('–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏', async () => {
            const result = await mockGetSubscription(mockUserId)

            expect(result.success).toBe(false)
            expect(result.error).toBe('–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞')
        })

        it('–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –ø–æ–¥–ø–∏—Å–∫—É —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', async () => {
            // –°–æ–∑–¥–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É
            await mockCreateSubscription(mockUserId, 'free')

            const result = await mockGetSubscription(mockUserId)

            expect(result.success).toBe(true)
            expect(result.subscription).toBeDefined()
            expect(result.subscription?.userId).toBe(mockUserId)
            expect(result.subscription?.tier).toBe('free')
        })

        it('–¥–æ–ª–∂–µ–Ω –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ', async () => {
            await mockGetSubscription(mockUserId)

            expect(mockConsoleLog).toHaveBeenCalledWith(
                'üß™ MOCK –†–ï–ñ–ò–ú: –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Supabase'
            )
        })
    })

    describe('mockCreateSubscription', () => {
        it('–¥–æ–ª–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É', async () => {
            const result = await mockCreateSubscription(mockUserId, 'premium')

            expect(result.success).toBe(true)
            expect(result.subscription).toBeDefined()
            expect(result.subscription?.userId).toBe(mockUserId)
            expect(result.subscription?.tier).toBe('premium')
            expect(result.subscription?.status).toBe('active')
            expect(result.subscription?.id).toMatch(/^mock-sub-\d+-[a-z0-9]+$/)
        })

        it('–¥–æ–ª–∂–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã', async () => {
            const beforeCreate = new Date()
            const result = await mockCreateSubscription(mockUserId, 'free')
            const afterCreate = new Date()

            expect(result.subscription?.currentPeriodStart).toBeInstanceOf(Date)
            expect(result.subscription?.currentPeriodEnd).toBeInstanceOf(Date)
            expect(result.subscription?.currentPeriodStart.getTime()).toBeGreaterThanOrEqual(beforeCreate.getTime())
            expect(result.subscription?.currentPeriodStart.getTime()).toBeLessThanOrEqual(afterCreate.getTime())

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–µ—Ä–∏–æ–¥ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü
            const expectedEnd = new Date(result.subscription?.currentPeriodStart || 0)
            expectedEnd.setMonth(expectedEnd.getMonth() + 1)
            expect(result.subscription?.currentPeriodEnd?.getTime()).toBeCloseTo(expectedEnd.getTime(), -3) // –¢–æ—á–Ω–æ—Å—Ç—å –¥–æ —Å–µ–∫—É–Ω–¥—ã
        })

        it('–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–æ–∑–¥–∞—Ç—å –≤—Ç–æ—Ä—É—é –ø–æ–¥–ø–∏—Å–∫—É', async () => {
            // –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É
            await mockCreateSubscription(mockUserId, 'free')

            // –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å –≤—Ç–æ—Ä—É—é –ø–æ–¥–ø–∏—Å–∫—É
            const result = await mockCreateSubscription(mockUserId, 'premium')

            expect(result.success).toBe(false)
            expect(result.error).toBe('–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞')
        })

        it('–¥–æ–ª–∂–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å cancelAtPeriodEnd –≤ false –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é', async () => {
            const result = await mockCreateSubscription(mockUserId, 'pro')

            expect(result.subscription?.cancelAtPeriodEnd).toBe(false)
        })

        it('–¥–æ–ª–∂–µ–Ω –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ', async () => {
            await mockCreateSubscription(mockUserId, 'free')

            expect(mockConsoleLog).toHaveBeenCalledWith(
                'üß™ MOCK –†–ï–ñ–ò–ú: –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Supabase'
            )
        })
    })

    describe('mockUpdateSubscription', () => {
        let subscriptionId: string

        beforeEach(async () => {
            const result = await mockCreateSubscription(mockUserId, 'free')
            subscriptionId = result.subscription?.id || ''
        })

        it('–¥–æ–ª–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–æ–¥–ø–∏—Å–∫—É', async () => {
            const updates = {
                tier: 'premium' as SubscriptionTier,
                cancelAtPeriodEnd: true
            }

            const result = await mockUpdateSubscription(subscriptionId, updates)

            expect(result.success).toBe(true)
            expect(result.subscription?.tier).toBe('premium')
            expect(result.subscription?.cancelAtPeriodEnd).toBe(true)
        })

        it('–¥–æ–ª–∂–µ–Ω –æ–±–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É updatedAt', async () => {
            const originalUpdatedAt = new Date()

            // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ, —á—Ç–æ–±—ã –≤—Ä–µ–º—è –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
            await new Promise(resolve => setTimeout(resolve, 10))

            const updates = { tier: 'premium' as SubscriptionTier }
            const result = await mockUpdateSubscription(subscriptionId, updates)

            expect(result.subscription?.updatedAt.getTime()).toBeGreaterThan(originalUpdatedAt.getTime())
        })

        it('–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ø–æ–¥–ø–∏—Å–∫–∏', async () => {
            const updates = { tier: 'premium' as SubscriptionTier }
            const result = await mockUpdateSubscription('non-existent-id', updates)

            expect(result.success).toBe(false)
            expect(result.error).toBe('–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞')
        })

        it('–¥–æ–ª–∂–µ–Ω –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ', async () => {
            const updates = { tier: 'premium' as SubscriptionTier }
            await mockUpdateSubscription(subscriptionId, updates)

            expect(mockConsoleLog).toHaveBeenCalledWith(
                'üß™ MOCK –†–ï–ñ–ò–ú: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Supabase'
            )
        })
    })

    describe('mockCancelSubscription', () => {
        let subscriptionId: string

        beforeEach(async () => {
            const result = await mockCreateSubscription(mockUserId, 'premium')
            subscriptionId = result.subscription?.id || ''
        })

        it('–¥–æ–ª–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É', async () => {
            const result = await mockCancelSubscription(subscriptionId)

            expect(result.success).toBe(true)
            expect(result.subscription?.status).toBe('canceled')
            expect(result.subscription?.cancelAtPeriodEnd).toBe(true)
        })

        it('–¥–æ–ª–∂–µ–Ω –æ–±–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É updatedAt', async () => {
            const originalUpdatedAt = new Date()

            await new Promise(resolve => setTimeout(resolve, 10))

            const result = await mockCancelSubscription(subscriptionId)

            expect(result.subscription?.updatedAt.getTime()).toBeGreaterThan(originalUpdatedAt.getTime())
        })

        it('–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ø–æ–¥–ø–∏—Å–∫–∏', async () => {
            const result = await mockCancelSubscription('non-existent-id')

            expect(result.success).toBe(false)
            expect(result.error).toBe('–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞')
        })

        it('–¥–æ–ª–∂–µ–Ω –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ', async () => {
            await mockCancelSubscription(subscriptionId)

            expect(mockConsoleLog).toHaveBeenCalledWith(
                'üß™ MOCK –†–ï–ñ–ò–ú: –û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Supabase'
            )
        })
    })

    describe('mockGetSubscriptionPlans', () => {
        it('–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–ª–∞–Ω—ã –ø–æ–¥–ø–∏—Å–æ–∫', async () => {
            const result = await mockGetSubscriptionPlans()

            expect(result.success).toBe(true)
            expect(result.plans).toBeDefined()
            expect(result.plans).toHaveLength(3) // free, premium, pro

            const planNames = result.plans?.map(plan => plan.name) || []
            expect(planNames).toContain('Free')
            expect(planNames).toContain('Premium')
            expect(planNames).toContain('Pro')
        })

        it('–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –ø–ª–∞–Ω—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –¥–∞–Ω–Ω—ã—Ö', async () => {
            const result = await mockGetSubscriptionPlans()

            expect(result.success).toBe(true)
            expect(result.plans).toBeDefined()

            const freePlan = result.plans?.find(plan => plan.tier === 'free')
            expect(freePlan).toMatchObject({
                id: 'plan-free',
                name: 'Free',
                tier: 'free',
                price: 0,
                currency: 'RUB',
                interval: 'month',
                isActive: true
            })

            const premiumPlan = result.plans?.find(plan => plan.tier === 'premium')
            expect(premiumPlan).toMatchObject({
                id: 'plan-premium',
                name: 'Premium',
                tier: 'premium',
                price: 99900, // 999 —Ä—É–±–ª–µ–π –≤ –∫–æ–ø–µ–π–∫–∞—Ö
                currency: 'RUB',
                interval: 'month',
                isActive: true
            })

            const proPlan = result.plans?.find(plan => plan.tier === 'pro')
            expect(proPlan).toMatchObject({
                id: 'plan-pro',
                name: 'Pro',
                tier: 'pro',
                price: 199900, // 1999 —Ä—É–±–ª–µ–π –≤ –∫–æ–ø–µ–π–∫–∞—Ö
                currency: 'RUB',
                interval: 'month',
                isActive: true
            })
        })

        it('–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –ø–ª–∞–Ω—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ª–∏–º–∏—Ç–∞–º–∏', async () => {
            const result = await mockGetSubscriptionPlans()

            const freePlan = result.plans?.find(plan => plan.tier === 'free')
            expect(freePlan?.limits).toMatchObject({
                tasks: 50,
                aiRequests: 10,
                storage: 100
            })

            const premiumPlan = result.plans?.find(plan => plan.tier === 'premium')
            expect(premiumPlan?.limits).toMatchObject({
                tasks: 500,
                aiRequests: 100,
                storage: 1000
            })

            const proPlan = result.plans?.find(plan => plan.tier === 'pro')
            expect(proPlan?.limits).toMatchObject({
                tasks: -1, // -1 –æ–∑–Ω–∞—á–∞–µ—Ç –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ
                aiRequests: -1,
                storage: 10000
            })
        })

        it('–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –ø–ª–∞–Ω—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏', async () => {
            const result = await mockGetSubscriptionPlans()

            const freePlan = result.plans?.find(plan => plan.tier === 'free')
            expect(freePlan?.features).toContain('–î–æ 50 –∑–∞–¥–∞—á –≤ –º–µ—Å—è—Ü')
            expect(freePlan?.features).toContain('–ë–∞–∑–æ–≤–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ')
            expect(freePlan?.features).toContain('Email –ø–æ–¥–¥–µ—Ä–∂–∫–∞')

            const premiumPlan = result.plans?.find(plan => plan.tier === 'premium')
            expect(premiumPlan?.features).toContain('–î–æ 500 –∑–∞–¥–∞—á –≤ –º–µ—Å—è—Ü')
            expect(premiumPlan?.features).toContain('–ò–ò –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫')
            expect(premiumPlan?.features).toContain('–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞')
            expect(premiumPlan?.features).toContain('–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏')

            const proPlan = result.plans?.find(plan => plan.tier === 'pro')
            expect(proPlan?.features).toContain('–ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏')
            expect(proPlan?.features).toContain('–í—Å–µ –ò–ò –º–æ–¥–µ–ª–∏')
            expect(proPlan?.features).toContain('–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä')
            expect(proPlan?.features).toContain('API –¥–æ—Å—Ç—É–ø')
            expect(proPlan?.features).toContain('–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏')
        })

        it('–¥–æ–ª–∂–µ–Ω –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ', async () => {
            await mockGetSubscriptionPlans()

            expect(mockConsoleLog).toHaveBeenCalledWith(
                'üß™ MOCK –†–ï–ñ–ò–ú: –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤ –ø–æ–¥–ø–∏—Å–æ–∫ –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Supabase'
            )
        })
    })

    describe('mockGetSubscriptionStatus', () => {
        it('–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏', async () => {
            const result = await mockGetSubscriptionStatus(mockUserId)

            expect(result.success).toBe(false)
            expect(result.error).toBe('–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞')
        })

        it('–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏', async () => {
            await mockCreateSubscription(mockUserId, 'premium')

            const result = await mockGetSubscriptionStatus(mockUserId)

            expect(result.success).toBe(true)
            expect(result.status).toBeDefined()
            expect(result.status?.tier).toBe('premium')
            expect(result.status?.status).toBe('active')
            expect(result.status?.isActive).toBe(true)
            expect(result.status?.canUpgrade).toBe(true)
            expect(result.status?.canDowngrade).toBe(true)
        })

        it('–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ª–∏–º–∏—Ç—ã –¥–ª—è free –ø–ª–∞–Ω–∞', async () => {
            await mockCreateSubscription(mockUserId, 'free')

            const result = await mockGetSubscriptionStatus(mockUserId)

            expect(result.success).toBe(true)
            expect(result.status?.limits).toMatchObject({
                tasks: 50,
                aiRequests: 10,
                storage: 100
            })
        })

        it('–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ª–∏–º–∏—Ç—ã –¥–ª—è premium –ø–ª–∞–Ω–∞', async () => {
            await mockCreateSubscription(mockUserId, 'premium')

            const result = await mockGetSubscriptionStatus(mockUserId)

            expect(result.success).toBe(true)
            expect(result.status?.limits).toMatchObject({
                tasks: 500,
                aiRequests: 100,
                storage: 1000
            })
        })

        it('–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ª–∏–º–∏—Ç—ã –¥–ª—è pro –ø–ª–∞–Ω–∞', async () => {
            await mockCreateSubscription(mockUserId, 'pro')

            const result = await mockGetSubscriptionStatus(mockUserId)

            expect(result.success).toBe(true)
            expect(result.status?.limits).toMatchObject({
                tasks: -1, // -1 –æ–∑–Ω–∞—á–∞–µ—Ç –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ
                aiRequests: -1,
                storage: 10000
            })
        })

        it('–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å mock –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ', async () => {
            await mockCreateSubscription(mockUserId, 'premium')

            const result = await mockGetSubscriptionStatus(mockUserId)

            expect(result.success).toBe(true)
            expect(result.status?.usage).toMatchObject({
                tasks: 15,
                aiRequests: 3,
                storage: 25
            })
        })

        it('–¥–æ–ª–∂–µ–Ω –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å canUpgrade –ø—Ä–∞–≤–∏–ª—å–Ω–æ', async () => {
            // Free –ø–ª–∞–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω
            await mockCreateSubscription(mockUserId, 'free')
            let result = await mockGetSubscriptionStatus(mockUserId)
            expect(result.status?.canUpgrade).toBe(true)

            // Premium –ø–ª–∞–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω
            clearMockSubscriptions()
            await mockCreateSubscription(mockUserId, 'premium')
            result = await mockGetSubscriptionStatus(mockUserId)
            expect(result.status?.canUpgrade).toBe(true)

            // Pro –ø–ª–∞–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω
            clearMockSubscriptions()
            await mockCreateSubscription(mockUserId, 'pro')
            result = await mockGetSubscriptionStatus(mockUserId)
            expect(result.status?.canUpgrade).toBe(false)
        })

        it('–¥–æ–ª–∂–µ–Ω –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å canDowngrade –ø—Ä–∞–≤–∏–ª—å–Ω–æ', async () => {
            // Free –ø–ª–∞–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–Ω–∏–∂–µ–Ω
            await mockCreateSubscription(mockUserId, 'free')
            let result = await mockGetSubscriptionStatus(mockUserId)
            expect(result.status?.canDowngrade).toBe(false)

            // Premium –ø–ª–∞–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–Ω–∏–∂–µ–Ω
            clearMockSubscriptions()
            await mockCreateSubscription(mockUserId, 'premium')
            result = await mockGetSubscriptionStatus(mockUserId)
            expect(result.status?.canDowngrade).toBe(true)

            // Pro –ø–ª–∞–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–Ω–∏–∂–µ–Ω
            clearMockSubscriptions()
            await mockCreateSubscription(mockUserId, 'pro')
            result = await mockGetSubscriptionStatus(mockUserId)
            expect(result.status?.canDowngrade).toBe(true)
        })

        it('–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–ª–∞–Ω–∞', async () => {
            // –°–æ–∑–¥–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É —Å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø–ª–∞–Ω–æ–º (—ç—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏)
            addMockSubscription({
                id: 'test-sub',
                userId: mockUserId,
                tier: 'invalid' as SubscriptionTier,
                status: 'active',
                currentPeriodStart: new Date(),
                currentPeriodEnd: new Date(),
                cancelAtPeriodEnd: false,
                createdAt: new Date(),
                updatedAt: new Date()
            })

            const result = await mockGetSubscriptionStatus(mockUserId)

            expect(result.success).toBe(false)
            expect(result.error).toBe('–ü–ª–∞–Ω –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω')
        })

        it('–¥–æ–ª–∂–µ–Ω –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ', async () => {
            await mockCreateSubscription(mockUserId, 'free')
            await mockGetSubscriptionStatus(mockUserId)

            expect(mockConsoleLog).toHaveBeenCalledWith(
                'üß™ MOCK –†–ï–ñ–ò–ú: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Supabase'
            )
        })
    })

    describe('–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏', () => {
        describe('clearMockSubscriptions', () => {
            it('–¥–æ–ª–∂–µ–Ω –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ mock –ø–æ–¥–ø–∏—Å–∫–∏', async () => {
                await mockCreateSubscription(mockUserId, 'free')
                expect(await mockGetSubscription(mockUserId)).toMatchObject({ success: true })

                clearMockSubscriptions()
                expect(await mockGetSubscription(mockUserId)).toMatchObject({ success: false })
            })

            it('–¥–æ–ª–∂–µ–Ω –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ', () => {
                clearMockSubscriptions()

                expect(mockConsoleLog).toHaveBeenCalledWith(
                    'üß™ MOCK –†–ï–ñ–ò–ú: –û—á–∏—Å—Ç–∫–∞ mock –ø–æ–¥–ø–∏—Å–æ–∫'
                )
            })
        })

        describe('addMockSubscription', () => {
            it('–¥–æ–ª–∂–µ–Ω –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –≤ mock –¥–∞–Ω–Ω—ã–µ', () => {
                const subscription: Subscription = {
                    id: 'test-sub',
                    userId: mockUserId,
                    tier: 'premium',
                    status: 'active',
                    currentPeriodStart: new Date(),
                    currentPeriodEnd: new Date(),
                    cancelAtPeriodEnd: false,
                    createdAt: new Date(),
                    updatedAt: new Date()
                }

                addMockSubscription(subscription)

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–¥–ø–∏—Å–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞
                mockGetSubscription(mockUserId).then(result => {
                    expect(result.success).toBe(true)
                    expect(result.subscription?.id).toBe('test-sub')
                })
            })

            it('–¥–æ–ª–∂–µ–Ω –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ', () => {
                const subscription: Subscription = {
                    id: 'test-sub',
                    userId: mockUserId,
                    tier: 'premium',
                    status: 'active',
                    currentPeriodStart: new Date(),
                    currentPeriodEnd: new Date(),
                    cancelAtPeriodEnd: false,
                    createdAt: new Date(),
                    updatedAt: new Date()
                }

                addMockSubscription(subscription)

                expect(mockConsoleLog).toHaveBeenCalledWith(
                    'üß™ MOCK –†–ï–ñ–ò–ú: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–∏'
                )
            })
        })
    })
})
