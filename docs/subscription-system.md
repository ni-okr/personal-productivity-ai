# üí≥ –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –∏ –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å –¢–∏–Ω—å–∫–æ—Ñ—Ñ –≠–∫–≤–∞–π—Ä–∏–Ω–≥ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∞–º–∏. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏ –ò–ò.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã:

1. **–¢–∏–Ω—å–∫–æ—Ñ—Ñ Integration** (`src/lib/tinkoff.ts`)
   - –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤
   - Payment —Å–µ—Å—Å–∏–∏
   - Customer Portal
   - Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞

2. **Subscription Management** (`src/lib/subscriptions.ts`)
   - CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞–Ω–∞–º–∏
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Supabase

3. **UI Components**
   - `SubscriptionModal` - –≤—ã–±–æ—Ä –ø–ª–∞–Ω–∞
   - `SubscriptionStatus` - —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏
   - `SubscriptionCard` - –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–ª–∞–Ω–∞

4. **API Routes**
   - `/api/subscriptions/create-checkout` - —Å–æ–∑–¥–∞–Ω–∏–µ checkout
   - `/api/subscriptions/portal` - customer portal
   - `/api/subscriptions/webhook` - webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞
   - `/api/subscriptions/status` - —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏
   - `/api/subscriptions/plans` - –ø–ª–∞–Ω—ã –ø–æ–¥–ø–∏—Å–æ–∫

## üí∞ –¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã

### Free Tier
- **–¶–µ–Ω–∞**: –ë–µ—Å–ø–ª–∞—Ç–Ω–æ
- **–ó–∞–¥–∞—á–∏**: 50
- **–ò–ò –∑–∞–ø—Ä–æ—Å—ã**: 10/–¥–µ–Ω—å
- **–•—Ä–∞–Ω–∏–ª–∏—â–µ**: 100 MB
- **–§—É–Ω–∫—Ü–∏–∏**: –ë–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫, Mock AI

### Premium Tier
- **–¶–µ–Ω–∞**: ‚ÇΩ999/–º–µ—Å—è—Ü
- **–ó–∞–¥–∞—á–∏**: 500
- **–ò–ò –∑–∞–ø—Ä–æ—Å—ã**: 1000/–¥–µ–Ω—å
- **–•—Ä–∞–Ω–∏–ª–∏—â–µ**: 1 GB
- **–§—É–Ω–∫—Ü–∏–∏**: OpenAI GPT-4o Mini, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞

### Pro Tier
- **–¶–µ–Ω–∞**: ‚ÇΩ1999/–º–µ—Å—è—Ü
- **–ó–∞–¥–∞—á–∏**: –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ
- **–ò–ò –∑–∞–ø—Ä–æ—Å—ã**: –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ
- **–•—Ä–∞–Ω–∏–ª–∏—â–µ**: 10 GB
- **–§—É–Ω–∫—Ü–∏–∏**: –í—Å–µ –ò–ò –º–æ–¥–µ–ª–∏, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, API –¥–æ—Å—Ç—É–ø

### Enterprise Tier
- **–¶–µ–Ω–∞**: –ü–æ –∑–∞–ø—Ä–æ—Å—É
- **–§—É–Ω–∫—Ü–∏–∏**: –ë–µ–ª—ã–π –ª–µ–π–±–ª, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –¢–∏–Ω—å–∫–æ—Ñ—Ñ Configuration

```env
TINKOFF_TERMINAL_KEY=your_terminal_key
TINKOFF_SECRET_KEY=your_secret_key
TINKOFF_WEBHOOK_SECRET=your_webhook_secret
```

### 2. Database Schema

```sql
-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–¥–ø–∏—Å–æ–∫
CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  tier subscription_tier NOT NULL,
  status subscription_status NOT NULL,
  tinkoff_customer_id TEXT,
  tinkoff_payment_id TEXT,
  current_period_start TIMESTAMP WITH TIME ZONE,
  current_period_end TIMESTAMP WITH TIME ZONE,
  cancel_at_period_end BOOLEAN DEFAULT FALSE,
  trial_end TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –¢–∞–±–ª–∏—Ü–∞ –ø–ª–∞–Ω–æ–≤ –ø–æ–¥–ø–∏—Å–æ–∫
CREATE TABLE subscription_plans (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  tier subscription_tier NOT NULL,
  price INTEGER NOT NULL, -- –≤ –∫–æ–ø–µ–π–∫–∞—Ö
  currency TEXT DEFAULT 'RUB',
  interval TEXT NOT NULL, -- 'month' –∏–ª–∏ 'year'
  features TEXT[] NOT NULL,
  limits JSONB NOT NULL,
  tinkoff_price_id TEXT,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 3. RLS Policies

```sql
-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏
CREATE POLICY "Users can view own subscriptions" ON subscriptions
  FOR SELECT USING (auth.uid() = user_id);

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–≤–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏
CREATE POLICY "Users can create own subscriptions" ON subscriptions
  FOR INSERT WITH CHECK (auth.uid() = user_id);

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å —Å–≤–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏
CREATE POLICY "Users can update own subscriptions" ON subscriptions
  FOR UPDATE USING (auth.uid() = user_id);

-- –ü–ª–∞–Ω—ã –ø–æ–¥–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º
CREATE POLICY "Subscription plans are public" ON subscription_plans
  FOR SELECT USING (is_active = TRUE);
```

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω–∏–µ checkout —Å–µ—Å—Å–∏–∏

```typescript
import { useSubscription } from '@/hooks/useSubscription'

function UpgradeButton() {
  const { createCheckoutSession } = useSubscription()

  const handleUpgrade = async () => {
    const result = await createCheckoutSession('plan-premium')
    
    if (result.success && result.url) {
      window.location.href = result.url
    }
  }

  return <button onClick={handleUpgrade}>–û–±–Ω–æ–≤–∏—Ç—å –¥–æ Premium</button>
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏

```typescript
import { useSubscription } from '@/hooks/useSubscription'

function SubscriptionInfo() {
  const { subscription, plan, isLoading } = useSubscription()

  if (isLoading) return <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>

  return (
    <div>
      <h3>{plan?.name}</h3>
      <p>–°—Ç–∞—Ç—É—Å: {subscription?.status}</p>
      <p>–°–ª–µ–¥—É—é—â–µ–µ —Å–ø–∏—Å–∞–Ω–∏–µ: {subscription?.currentPeriodEnd}</p>
    </div>
  )
}
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π

```typescript
import { useSubscription } from '@/hooks/useSubscription'

function ManageSubscription() {
  const { createPortalSession } = useSubscription()

  const handleManage = async () => {
    const result = await createPortalSession()
    
    if (result.success && result.url) {
      window.open(result.url, '_blank')
    }
  }

  return <button onClick={handleManage}>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π</button>
}
```

## üîî Webhook Events

### –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–µ —Å–æ–±—ã—Ç–∏—è:

1. **customer.subscription.created** - –Ω–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
2. **customer.subscription.updated** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
3. **customer.subscription.deleted** - –æ—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏
4. **invoice.payment_succeeded** - —É—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞
5. **invoice.payment_failed** - –Ω–µ—É–¥–∞—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞

### Webhook Handler

```typescript
// src/app/api/subscriptions/webhook/route.ts
export async function POST(request: NextRequest) {
  const body = await request.text()
  const signature = headers().get('stripe-signature')

  const result = await handleStripeWebhook(body, signature)
  
  if (result.success) {
    return NextResponse.json({ received: true })
  } else {
    return NextResponse.json({ error: result.error }, { status: 400 })
  }
}
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit Tests
- `tests/unit/subscriptions.test.ts` - —Ç–µ—Å—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∞–º–∏
- `tests/unit/tinkoff.test.ts` - —Ç–µ—Å—Ç—ã –¢–∏–Ω—å–∫–æ—Ñ—Ñ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### Integration Tests
- `tests/integration/subscription-integration.test.tsx` - —Ç–µ—Å—Ç—ã UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
# Unit —Ç–µ—Å—Ç—ã
npm run test:unit

# Integration —Ç–µ—Å—Ç—ã
npm run test:integration

# –í—Å–µ —Ç–µ—Å—Ç—ã
npm run test
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 1. Webhook Verification
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –¢–∏–Ω—å–∫–æ—Ñ—Ñ
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π
- Idempotency –æ–±—Ä–∞–±–æ—Ç–∫–∞

### 2. RLS Policies
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –∏–º–µ—é—Ç –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
- –ê—É–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π

### 3. API Security
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- Rate limiting

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:

1. **–ö–æ–Ω–≤–µ—Ä—Å–∏—è**: Free ‚Üí Premium ‚Üí Pro
2. **Churn Rate**: –ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–º–µ–Ω –ø–æ–¥–ø–∏—Å–æ–∫
3. **MRR**: Monthly Recurring Revenue
4. **ARPU**: Average Revenue Per User
5. **LTV**: Lifetime Value

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:

```typescript
// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –ø–æ–¥–ø–∏—Å–∫–∏
console.log('Subscription created:', {
  userId: subscription.userId,
  tier: subscription.tier,
  amount: plan.price,
  timestamp: new Date().toISOString()
})
```

## üö® Troubleshooting

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **Webhook –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å URL –≤ –¢–∏–Ω—å–∫–æ—Ñ—Ñ Dashboard
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å—å webhook
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞

2. **Payment –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¢–∏–Ω—å–∫–æ—Ñ—Ñ –∫–ª—é—á–∏
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –ø–ª–∞–Ω–∞

3. **Portal –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å customer ID
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Portal –≤ –¢–∏–Ω—å–∫–æ—Ñ—Ñ
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å return URL

### Debug —Ä–µ–∂–∏–º:

```typescript
// –í–∫–ª—é—á–∏—Ç—å debug –ª–æ–≥–∏
process.env.TINKOFF_DEBUG = 'true'
```

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è

### –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:

```sql
-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è
ALTER TABLE subscriptions ADD COLUMN trial_end TIMESTAMP WITH TIME ZONE;

-- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π
UPDATE subscriptions SET trial_end = current_period_end WHERE tier = 'premium';
```

### –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ API:

- v1: –ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- v2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Enterprise –ø–ª–∞–Ω–æ–≤
- v3: –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è: —Å–µ–º–µ–π–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏

## üìà Roadmap

### Q1 2025:
- [ ] –°–µ–º–µ–π–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏
- [ ] –ì–æ–¥–æ–≤—ã–µ —Å–∫–∏–¥–∫–∏
- [ ] –ü—Ä–æ–º–æ–∫–æ–¥—ã

### Q2 2025:
- [ ] –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –ø–ª–∞–Ω—ã
- [ ] API –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
- [ ] –ê—Ñ—Ñ–∏–ª–∏–∞—Ç–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞

### Q3 2025:
- [ ] –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
- [ ] –õ–æ–∫–∞–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã
- [ ] –ú–æ–±–∏–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
